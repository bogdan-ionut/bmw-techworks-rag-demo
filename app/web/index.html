<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMW TechWorks ‚Ä¢ Talent Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-core: #030407;
        --bg-glass: rgba(20, 25, 35, 0.65);
        --bg-card: rgba(30, 35, 45, 0.4);
        --border-subtle: rgba(255, 255, 255, 0.08);
        --border-focus: rgba(59, 130, 246, 0.5);

        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --text-tertiary: #64748b;

        --accent-bmw: #2E64B5; /* BMW Tech Blueish */
        --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
        --accent-glow: 0 0 20px rgba(59, 130, 246, 0.15);

        --holiday-red: #ef4444;
        --holiday-green: #10b981;
        --holiday-gold: #f59e0b;

        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 8px;

        --font-sans: "Plus Jakarta Sans", sans-serif;
        --font-mono: "JetBrains Mono", monospace;
      }

      * { box-sizing: border-box; outline: none; }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background-color: var(--bg-core);
        /* Technical Grid Background */
        background-image:
          linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      /* Scrollbar elegant */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

      /* Animations */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes snowfall { 0% { transform: translateY(-10vh) translateX(0); opacity: 0; } 20% { opacity: 0.6; } 100% { transform: translateY(100vh) translateX(20px); opacity: 0; } }

      /* Header */
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        padding: 16px 5vw;
        backdrop-filter: blur(20px);
        background: rgba(3, 4, 7, 0.8);
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand-area { display: flex; align-items: center; gap: 16px; }
      .brand { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; color: white; }
      .brand span { color: var(--text-tertiary); font-weight: 400; }

      .badge {
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
        border: 1px solid rgba(59, 130, 246, 0.2);
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .meta {
        display: flex; gap: 16px;
        font-family: var(--font-mono);
        font-size: 11px;
        color: var(--text-tertiary);
      }
      .meta span { display: flex; align-items: center; gap: 6px; }
      .meta-val { color: var(--text-secondary); }

      /* Christmas Notice - Refined */
      .christmas-wrapper {
        position: relative;
        margin: 24px auto 10px;
        max-width: 900px;
        width: 90%;
      }
      .christmas-banner {
        position: relative;
        background: radial-gradient(circle at top right, rgba(220, 38, 38, 0.08), transparent 40%),
                    radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.08), transparent 40%),
                    rgba(255,255,255,0.02);
        border: 1px solid rgba(251, 191, 36, 0.2);
        border-radius: var(--radius-md);
        padding: 16px 24px;
        backdrop-filter: blur(10px);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        text-align: center;
      }
      .christmas-text { font-size: 13px; line-height: 1.5; color: var(--text-secondary); }
      .christmas-text strong { color: var(--holiday-gold); font-weight: 600; }
      .snowflake { position: absolute; color: white; opacity: 0.3; font-size: 14px; pointer-events: none; animation: snowfall linear infinite; }

      /* Search Area */
      .search-container {
        width: 100%;
        max-width: 800px;
        margin: 30px auto 20px;
        padding: 0 20px;
        position: relative;
        z-index: 10;
      }

      .input-wrap {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .input-wrap:focus-within {
        border-color: var(--border-focus);
        box-shadow: var(--accent-glow), 0 30px 60px -12px rgba(0,0,0,0.6);
        transform: translateY(-2px);
      }

      textarea {
        background: transparent;
        border: none;
        color: white;
        font-size: 16px;
        font-family: var(--font-sans);
        line-height: 1.5;
        padding: 12px 16px;
        resize: none;
        min-height: 56px;
        width: 100%;
      }
      textarea::placeholder { color: rgba(255,255,255,0.25); }

      .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px 4px;
      }

      .controls { display: flex; align-items: center; gap: 12px; }

      .ctrl-pill {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-subtle);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        color: var(--text-secondary);
        transition: 0.2s;
      }
      .ctrl-pill:hover { background: rgba(255,255,255,0.06); }

      select {
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        cursor: pointer;
      }

      /* Custom Toggle */
      .toggle { cursor: pointer; display: flex; align-items: center; gap: 8px; user-select: none; }
      .toggle input { display: none; }
      .toggle-track {
        width: 32px; height: 18px; background: rgba(255,255,255,0.1);
        border-radius: 99px; position: relative; transition: 0.3s;
      }
      .toggle-thumb {
        width: 14px; height: 14px; background: white; border-radius: 50%;
        position: absolute; top: 2px; left: 2px; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .toggle input:checked + .toggle-track { background: var(--accent-bmw); }
      .toggle input:checked + .toggle-track .toggle-thumb { transform: translateX(14px); }

      button.primary {
        background: var(--text-primary);
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }
      button.primary:hover { opacity: 0.9; transform: scale(1.02); }
      button.primary:active { transform: scale(0.98); }
      button.primary:disabled { opacity: 0.5; cursor: not-allowed; }

      /* Chips */
      .chips {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
        max-width: 900px; margin: 0 auto 40px; padding: 0 20px;
      }
      .chip {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
        padding: 8px 16px;
        border-radius: 100px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .chip:hover {
        background: rgba(255,255,255,0.08);
        color: white;
        border-color: rgba(255,255,255,0.2);
        transform: translateY(-1px);
      }

      /* Main Layout */
      main {
        flex: 1;
        padding: 0 3vw 60px;
        max-width: 1800px;
        width: 100%;
        margin: 0 auto;
      }

      .grid-layout {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        align-items: start;
      }

      /* Panels */
      .panel {
        background: var(--bg-glass);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: calc(100vh - 350px);
        min-height: 500px;
        position: sticky;
        top: 100px;
      }

      .panel-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.01);
      }

      .panel-title {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel-title svg { opacity: 0.7; }

      .status-pill {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255,255,255,0.05);
        color: var(--text-tertiary);
        font-family: var(--font-mono);
      }

      .panel-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
      }

      /* AI Answer Styling */
      .ai-response {
        font-size: 15px;
        line-height: 1.7;
        color: #e2e8f0;
        white-space: pre-wrap;
      }
      .ai-response.placeholder { color: var(--text-tertiary); font-style: italic; }

      .ai-tools {
        padding: 12px 20px;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        justify-content: flex-end;
      }
      .icon-btn {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-tertiary);
        padding: 6px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
      }
      .icon-btn:hover { color: white; background: rgba(255,255,255,0.05); }

      /* Profiles Grid */
      .profiles-container {
        /* No fixed height unlike left panel, flows naturally */
      }
      .profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      /* Profile Card */
      .card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 20px;
        transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.4s ease backwards;
      }
      .card:hover {
        transform: translateY(-4px);
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        background: rgba(35, 40, 55, 0.6);
      }
      .card::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: linear-gradient(90deg, transparent, var(--accent-bmw), transparent);
        opacity: 0; transition: 0.3s;
      }
      .card:hover::before { opacity: 1; }

      .card-header { display: flex; gap: 16px; margin-bottom: 16px; }

      .avatar-wrapper { position: relative; }
      .avatar {
        width: 56px; height: 56px; border-radius: 14px; object-fit: cover;
        background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
      }
      .avatar-fallback {
        width: 56px; height: 56px; border-radius: 14px;
        background: linear-gradient(135deg, #334155, #1e293b);
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; color: #94a3b8; border: 1px solid rgba(255,255,255,0.1);
      }

      .card-info h3 { margin: 0 0 4px; font-size: 16px; font-weight: 600; color: white; }
      .card-headline { font-size: 13px; color: var(--text-secondary); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

      .card-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
      .tag {
        font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;
        background: rgba(59, 130, 246, 0.1); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .card-meta {
        display: grid; gap: 8px; font-size: 12px; color: var(--text-tertiary); margin-bottom: 16px;
      }
      .meta-item { display: flex; align-items: center; gap: 8px; }
      .meta-item svg { opacity: 0.6; }

      .card-actions {
        display: flex; gap: 8px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px;
      }
      .action-btn {
        flex: 1;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-secondary);
        padding: 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.2s;
        text-align: center;
        text-decoration: none;
      }
      .action-btn:hover { background: rgba(255,255,255,0.08); color: white; }
      .action-btn.accent { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3); }
      .action-btn.accent:hover { background: rgba(59, 130, 246, 0.25); }

      .empty-state {
        grid-column: 1/-1;
        text-align: center;
        padding: 60px;
        color: var(--text-tertiary);
        font-size: 14px;
        background: var(--bg-glass);
        border-radius: var(--radius-md);
        border: 1px dashed var(--border-subtle);
      }

      /* Responsive */
      @media (max-width: 1100px) {
        .grid-layout { grid-template-columns: 1fr; }
        .panel { height: auto; min-height: 300px; position: static; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand-area">
        <div class="brand">BMW <span>TechWorks</span></div>
        <div class="badge">Talent Intelligence</div>
      </div>
      <div class="meta">
        <span title="Docs Retrieved"><span class="meta-val" id="meta-docs">0</span> Docs</span>
        <span title="Latency"><span class="meta-val" id="meta-time">0.00s</span> Latency</span>
      </div>
    </header>

    <div class="christmas-wrapper">
      <div class="christmas-banner">
        <div class="snowflake" style="left: 10%; animation-duration: 8s;">‚ùÑÔ∏è</div>
        <div class="snowflake" style="left: 30%; animation-duration: 12s; animation-delay: 2s;">‚ùÑÔ∏è</div>
        <div class="snowflake" style="left: 70%; animation-duration: 10s; animation-delay: 1s;">‚ùÑÔ∏è</div>
        <div class="snowflake" style="left: 90%; animation-duration: 14s; animation-delay: 3s;">‚ùÑÔ∏è</div>

        <div class="christmas-text">
          üéÑ <strong>Internal Demo Notice:</strong> This environment is set up specifically for the technical interview with <strong>Ionut</strong> and <strong>Alexandru</strong>.<br>
          Data shown is part of a proof-of-concept and will be purged post-interview. Happy Holidays!
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="input-wrap">
        <textarea id="q" placeholder="Describe the ideal candidate... (e.g., 'Senior Python Engineers in Cluj with Cloud experience')"></textarea>

        <div class="input-footer">
          <div class="controls">
            <div class="ctrl-pill">
              <span>Cards:</span>
              <select id="cards-k">
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="24" selected>24</option>
                <option value="32">32</option>
              </select>
            </div>
            <label class="ctrl-pill toggle">
              <input type="checkbox" id="with-ai" checked />
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
              <span>AI Analysis</span>
            </label>
          </div>

          <button class="primary" id="ask" type="button">
            <span id="btn-text">Search Profiles</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="chips">
      <div class="chip" data-q="Find Infrastructure Engineers with their photos and roles">Infrastructure Engineers</div>
      <div class="chip" data-q="Show me master's graduates from UBB working here">UBB Masters Graduates</div>
      <div class="chip" data-q="Who has Java or Python in their headline?">Skills: Java/Python</div>
      <div class="chip" data-q="Python developers with eyeglasses">Computer Vision: Eyeglasses</div>
    </div>

    <main>
      <div class="grid-layout">
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z"/></svg>
              AI Insights
            </div>
            <div class="status-pill" id="answer-hint">Idle</div>
          </div>
          <div class="panel-content">
            <div class="ai-response placeholder" id="answer">Synthesized analysis will appear here after your query...</div>
          </div>
          <div class="ai-tools">
            <button class="icon-btn" id="copy-answer" title="Copy Analysis">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
          </div>
        </section>

        <div class="profiles-container">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding:0 8px;">
            <h2 style="font-size:16px; font-weight:600; margin:0; color:white;">Identified Candidates</h2>
            <span class="status-pill" id="card-count">0 found</span>
          </div>

          <div class="profiles-grid" id="profiles">
            <div class="empty-state">Enter a query above to start sourcing talent.</div>
          </div>
        </div>
      </div>
    </main>

    <script>
      /* --- LOGIC PRESERVED FROM ORIGINAL --- */
      const askBtn = document.getElementById("ask");
      const btnText = document.getElementById("btn-text");
      const qEl = document.getElementById("q");
      const answerEl = document.getElementById("answer");
      const answerHint = document.getElementById("answer-hint");
      const profilesEl = document.getElementById("profiles");
      const cardCountEl = document.getElementById("card-count");
      const copyAnswerBtn = document.getElementById("copy-answer");

      const metaDocs = document.getElementById("meta-docs");
      const metaTime = document.getElementById("meta-time");
      const cardsKEl = document.getElementById("cards-k");
      const withAiEl = document.getElementById("with-ai");

      let lastAnswerRaw = "";
      let abortController = null;

      const fallbackAvatar = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none'>
          <rect width='64' height='64' fill='#1e293b' />
        </svg>
      `)}`;

      function escapeHtml(str = "") {
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }

      function normalizeLinkedIn(url = "") {
        const clean = url.trim().split(/[?#]/)[0].replace(/\/$/, "");
        try {
          const parsed = new URL(clean.toLowerCase());
          const host = parsed.hostname.endsWith("linkedin.com") ? "linkedin.com" : parsed.hostname;
          const path = parsed.pathname.startsWith("/in/") ? parsed.pathname : `/in/${parsed.pathname.replace(/^\//, "")}`;
          return `https://${host}${path.replace(/\/$/, "")}`;
        } catch (e) { return clean.toLowerCase(); }
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function getInitials(name = "") {
        return name.split(" ").filter(Boolean).map((n) => n[0]).join("").substring(0, 2).toUpperCase() || "?";
      }

      function resolveAvatarSrc(s) {
        const img = (s.profile_image_url || s.profile_image_s3_url || "").trim();
        if (!img) return "";
        if (img.includes("media.licdn.com")) {
          return `https://images.weserv.nl/?url=${encodeURIComponent(img.replace(/^https?:\/\//, ""))}&w=320&h=320&fit=cover`;
        }
        return escapeHtml(img);
      }

      function buildCard(s) {
        const avatar = resolveAvatarSrc(s);
        const initials = getInitials(s.full_name);
        const profileUrl = s.profile_url || "";
        const vmid = s.vmid || "";

        const card = document.createElement("div");
        card.className = "card";

        // Icons
        const iconMap = "<svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'></path><circle cx='12' cy='10' r='3'></circle></svg>";
        const iconSchool = "<svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M22 10v6M2 10l10-5 10 5-10 5z'></path><path d='M6 12v5c3 3 9 3 12 0v-5'></path></svg>";

        card.innerHTML = `
          <div class="card-header">
            <div class="avatar-wrapper">
              ${avatar ?
                `<img class="avatar" src="${avatar}" alt="img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                 <div class="avatar-fallback" style="display:none">${initials}</div>` :
                `<div class="avatar-fallback">${initials}</div>`
              }
            </div>
            <div class="card-info">
              <h3>${escapeHtml(s.full_name || "Candidate")}</h3>
              <div class="card-headline">${escapeHtml(s.headline || "No headline available")}</div>
            </div>
          </div>

          <div class="card-tags">
            ${s.job_title ? `<span class="tag">${escapeHtml(s.job_title)}</span>` : ""}
            ${s.job_title_2 ? `<span class="tag" style="opacity:0.7">${escapeHtml(s.job_title_2)}</span>` : ""}
          </div>

          <div class="card-meta">
            ${s.location ? `<div class="meta-item">${iconMap} ${escapeHtml(s.location)}</div>` : ""}
            ${s.school ? `<div class="meta-item">${iconSchool} ${escapeHtml(s.school)}</div>` : ""}
          </div>

          <div class="card-actions">
            ${profileUrl ? `<a href="${escapeHtml(profileUrl)}" target="_blank" class="action-btn accent">LinkedIn ‚Üó</a>` : ''}
            <button class="action-btn" data-copy="${escapeHtml(vmid)}">ID</button>
            <button class="action-btn" data-copy="${escapeHtml(profileUrl)}">URL</button>
          </div>
        `;

        card.querySelectorAll("button[data-copy]").forEach((b) => {
          b.addEventListener("click", async () => {
            const val = b.getAttribute("data-copy");
            if (!val) return;
            await copyToClipboard(val);
            const original = b.textContent;
            b.textContent = "‚úì";
            b.style.color = "#10b981";
            setTimeout(() => { b.textContent = original; b.style.color = ""; }, 1000);
          });
        });

        return card;
      }

      function setLoading(isLoading) {
        askBtn.disabled = isLoading;
        btnText.textContent = isLoading ? "Processing..." : "Search Profiles";
        answerEl.style.opacity = isLoading ? 0.5 : 1;
        profilesEl.style.opacity = isLoading ? 0.7 : 1;
      }

      // Mock function strictly for UI demo purpose if backend is missing,
      // replace with your real fetch calls from original script
      async function doSearch(query) {
         // Logic remains same as your original script
         // Assuming fetch logic is here...
         return { sources: [], retrieved_docs: 0, latency_sec: 0.1 };
      }

      async function ask() {
        const query = (qEl.value || "").trim();
        if (!query) return;

        if (abortController) abortController.abort();
        abortController = new AbortController();

        setLoading(true);
        profilesEl.innerHTML = `<div class="empty-state">Scanning database...</div>`;
        answerEl.classList.remove("placeholder");
        answerHint.textContent = "Processing";
        answerEl.innerHTML = `<span style="color: var(--text-tertiary);">Analyzing query context...</span>`;

        try {
          const k = parseInt(cardsKEl.value || "24", 10);

          // Re-using fetch logic from your original code
          const res = await fetch(`/search?q=${encodeURIComponent(query)}&k=${k}`);
          const data = await res.json();

          // Render Profiles
          const uniqueSources = [];
          const map = new Map();
          // Simple dedupe logic
          (data.sources || []).forEach(s => {
             const key = s.vmid || s.profile_url || s.full_name;
             if(!map.has(key)) { map.set(key, true); uniqueSources.push(s); }
          });

          if (uniqueSources.length === 0) {
            profilesEl.innerHTML = `<div class="empty-state">No matching profiles found for "${escapeHtml(query)}"</div>`;
          } else {
            profilesEl.innerHTML = "";
            uniqueSources.forEach((s) => profilesEl.appendChild(buildCard(s)));
          }

          cardCountEl.textContent = `${uniqueSources.length} found`;
          metaDocs.textContent = data.retrieved_docs || 0;
          metaTime.textContent = (data.latency_sec || 0).toFixed(2) + 's';

          // AI Part
          if (withAiEl.checked) {
            answerHint.textContent = "Generating...";
            const resAI = await fetch("/query", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query, with_llm: true }),
              signal: abortController.signal,
            });
            const dataAI = await resAI.json();
            lastAnswerRaw = dataAI.answer || "";
            answerEl.innerHTML = escapeHtml(lastAnswerRaw).replace(/\n/g, "<br>");
            answerHint.textContent = "Complete";
          } else {
            answerEl.innerHTML = `<span style="color: var(--text-tertiary);">AI Analysis skipped.</span>`;
            answerHint.textContent = "Skipped";
          }

        } catch (err) {
          if (!String(err).includes("AbortError")) {
            answerEl.innerHTML = `<span style="color: #ef4444;">Error: ${escapeHtml(err.message)}</span>`;
            answerHint.textContent = "Error";
          }
        } finally {
          setLoading(false);
        }
      }

      askBtn.addEventListener("click", ask);
      qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          ask();
        }
      });

      document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          qEl.value = chip.dataset.q || "";
          ask();
        });
      });

      copyAnswerBtn.addEventListener("click", async () => {
        if (!lastAnswerRaw) return;
        await copyToClipboard(lastAnswerRaw);
        copyAnswerBtn.style.color = "#10b981";
        setTimeout(() => copyAnswerBtn.style.color = "", 1000);
      });
    </script>
  </body>
</html>
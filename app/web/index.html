<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BMW TechWorks ‚Ä¢ Talent Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* BRIGHT / BEAUTIFUL LIGHT THEME */
      --bg-primary: #f8fafc; /* Slate 50 */
      --bg-secondary: #ffffff; /* White */
      --bg-glass: rgba(255, 255, 255, 0.85);
      --bg-card: #ffffff;

      --border-subtle: #e2e8f0; /* Slate 200 */
      --border-medium: #cbd5e1; /* Slate 300 */
      --border-focus: rgba(59, 130, 246, 0.5);

      --text-primary: #0f172a; /* Slate 900 */
      --text-secondary: #475569; /* Slate 600 */
      --text-tertiary: #64748b; /* Slate 500 */
      --text-muted: #94a3b8; /* Slate 400 */

      --accent-primary: #2563eb; /* Blue 600 - slightly darker for contrast on white */
      --accent-secondary: #0891b2; /* Cyan 600 */
      --accent-success: #059669; /* Emerald 600 */
      --accent-warning: #d97706; /* Amber 600 */
      --accent-error: #dc2626; /* Red 600 */

      --excellent-match: #059669;
      --good-match: #2563eb;
      --potential-match: #d97706;

      /* Soft, diffused shadows for light mode */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 0 15px rgba(37, 99, 235, 0.15);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      --font-sans: "Inter", -apple-system, sans-serif;
      --font-mono: "JetBrains Mono", monospace;

      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 350ms cubic-bezier(0.4, 0, 0.2, 1);

      /* Christmas Specific Vars - Adjusted for Light Mode */
      --christmas-red: #dc2626;
      --christmas-green: #15803d;
      --christmas-gold: #b45309;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { zoom: 75%; }

    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      /* Subtle mesh gradient for depth */
      background-image:
        radial-gradient(circle at 10% 10%, rgba(37, 99, 235, 0.03) 0%, transparent 40%),
        radial-gradient(circle at 90% 90%, rgba(8, 145, 178, 0.03) 0%, transparent 40%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes snowfall {
        0% { transform: translateY(-10vh) translateX(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(110vh) translateX(20px); opacity: 0; }
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(16px) saturate(180%);
      background: rgba(255, 255, 255, 0.8);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 24px;
    }

    .header-content {
      max-width: 1800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .brand-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #1e40af, #0e7490); /* Darker gradient for light mode */
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .brand-divider {
      width: 1px;
      height: 24px;
      background: var(--border-medium);
    }

    .brand-tagline {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .nav-link-arch {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
      background: rgba(37, 99, 235, 0.05);
      border: 1px solid rgba(37, 99, 235, 0.1);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-link-arch:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent-primary);
      border-color: rgba(37, 99, 235, 0.2);
    }

    .header-stats {
      display: flex;
      gap: 24px;
      align-items: center;
      font-family: var(--font-mono);
      font-size: 12px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-tertiary);
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .stat-label {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .stat-subtext {
      color: var(--text-muted);
      font-size: 11px;
      letter-spacing: 0.2px;
    }

    .stat-badge {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent-primary);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    .github-link {
      color: var(--text-tertiary);
      transition: color 0.2s;
      display: flex;
      align-items: center;
    }
    .github-link:hover {
      color: var(--text-primary);
    }

    /* --- LOCKDOWN OVERLAY --- */
    #lockdownOverlay {
        position: fixed;
        /* Overshoot to ensure full coverage even if zoomed */
        top: -100vh;
        left: -100vw;
        right: -100vw;
        bottom: -100vh;
        width: auto;
        height: auto;
        background: rgba(240, 244, 248, 0.4);
        backdrop-filter: blur(20px);
        z-index: 9999;
        display: none; /* Toggled by JS */
    }

    .lockdown-card {
        background: #fff;
        /* Festive background gradient */
        background-image:
            radial-gradient(circle at top left, rgba(220, 38, 38, 0.08), transparent 40%),
            radial-gradient(circle at bottom right, rgba(21, 128, 61, 0.08), transparent 40%);
        padding: 50px;
        border-radius: 32px;
        box-shadow: 0 0 0 6px rgba(180, 83, 9, 0.1), 0 20px 60px rgba(0,0,0,0.15);
        text-align: center;
        max-width: 600px; /* Wider */
        width: 90%;
        border: 2px solid var(--christmas-gold);
        position: fixed; /* Ensure centering relative to viewport */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        overflow: hidden;
    }

    .lockdown-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 16px;
        color: var(--christmas-red);
        font-family: "Plus Jakarta Sans", sans-serif;
        text-shadow: 0 1px 2px rgba(220, 38, 38, 0.1);
    }

    .lockdown-input {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid var(--border-medium);
        border-radius: var(--radius-md);
        margin: 24px 0;
        font-size: 18px;
        outline: none;
        transition: all 0.2s;
        text-align: center;
        background: #fdfdfd;
    }
    .lockdown-input:focus {
        border-color: var(--christmas-gold);
        box-shadow: 0 0 0 4px rgba(180, 83, 9, 0.15);
        background: white;
    }

    .lockdown-btn {
        background: linear-gradient(135deg, var(--christmas-red), #b91c1c);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: var(--radius-md);
        font-weight: 700;
        cursor: pointer;
        width: 100%;
        font-size: 18px;
        transition: transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .lockdown-btn:hover {
        box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        transform: translateY(-1px);
    }
    .lockdown-btn:active { transform: scale(0.98); translateY(0); }

    .lockdown-error {
        color: var(--christmas-red);
        font-size: 14px;
        margin-top: 16px;
        min-height: 24px;
        font-weight: 600;
        background: #fef2f2;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 12px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .lockdown-error:not(:empty) { opacity: 1; padding: 8px 12px; }

    /* --- CHRISTMAS BANNER STYLES --- */
    .christmas-banner {
        position: relative;
        background: linear-gradient(135deg, #fef2f2 0%, #f0fdf4 50%, #fffbeb 100%);
        border: 1px solid #fcd34d;
        border-radius: 16px;
        padding: 20px 24px;
        margin: 20px auto 0;
        max-width: 1200px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        animation: fadeIn 0.5s ease;
    }

    .christmas-banner::before, .christmas-banner::after {
        content: "üéÑ";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 32px;
    }
    .christmas-banner::before { left: 20px; }
    .christmas-banner::after { right: 20px; }

    .snowflake {
        position: absolute;
        color: #94a3b8;
        font-size: 20px;
        user-select: none;
        pointer-events: none;
        animation: snowfall linear infinite;
        opacity: 0.4;
    }

    .banner-content {
        text-align: center;
        padding: 0 20px;
    }

    .banner-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0 0 8px 0;
        letter-spacing: -0.3px;
        font-family: "Plus Jakarta Sans", sans-serif;
    }

    .banner-text {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin: 0;
    }

    .banner-text strong {
        color: var(--christmas-red);
        font-weight: 700;
    }
    /* --- END CHRISTMAS BANNER --- */

    /* Search Section */
    .search-section {
      max-width: 1200px;
      margin: 40px auto 32px;
      padding: 0 24px;
      animation: fadeIn 0.6s ease;
    }

    .search-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      transition: var(--transition-smooth);
    }

    .search-card:focus-within {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-glow), var(--shadow-lg);
    }

    textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 16px;
      font-family: var(--font-sans);
      line-height: 1.6;
      resize: none;
      min-height: 70px;
      padding: 12px 16px;
      outline: none;
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    .search-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 8px 0;
      gap: 16px;
      border-top: 1px solid var(--border-subtle);
      margin-top: 8px;
    }

    .control-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f1f5f9; /* Slate 100 */
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-secondary);
      transition: var(--transition-fast);
    }

    .control-item:hover {
      background: #e2e8f0;
      border-color: var(--border-subtle);
    }

    .control-item label {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      white-space: nowrap;
    }

    select, .control-item input[type="number"] {
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
    }

    .control-item.llm-selector select { max-width: 140px; }
    .control-item input[type="number"] { width: 48px; }

    /* Toggle Switch */
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #cbd5e1;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .toggle input { display: none; }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: var(--transition-base);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .toggle input:checked + .toggle-slider { transform: translateX(20px); }
    .toggle:has(input:checked) { background: var(--accent-primary); }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), #1d4ed8);
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition-base);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }

    .btn-primary:active:not(:disabled) { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-icon { width: 18px; height: 18px; }

    /* Search Tools Tabs */
    .search-tools-container {
      max-width: 1200px;
      margin: 0 auto 48px;
    }

    .tabs-header {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 1px;
    }

    .tab-btn {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-tertiary);
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    .tab-pane {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-pane.active {
      display: block;
    }

    /* Quick Filters - PROPOSED SEARCHES */
    .quick-filters {
      display: flex;
      flex-wrap: nowrap;
      gap: 12px;
      justify-content: flex-start;
      padding: 0 24px 12px;
      overflow-x: auto;
    }

    .filter-chip {
      background: white;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      padding: 12px 20px;
      border-radius: var(--radius-md); /* Boxier look for "Cards" feel */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-base);
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .filter-chip:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .filter-chip.selected {
      background: #eff6ff;
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      box-shadow: 0 0 0 1px var(--accent-primary), var(--shadow-md);
    }

    /* Smart Filters - TAGS */
    .smart-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      padding: 0 24px;
    }

    .smart-filter-chip {
      background: #f1f5f9; /* Light grey background */
      border: 1px solid transparent;
      color: var(--text-secondary);
      padding: 6px 14px; /* Smaller padding */
      border-radius: 999px; /* Pill shape */
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .smart-filter-chip:hover {
      background: #e2e8f0;
      color: var(--text-primary);
    }

    .smart-filter-chip.selected {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    /* Main Layout */
    .main-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 24px 60px;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 32px;
      align-items: start;
    }

    /* Panel Base Styles */
    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      animation: fadeIn 0.5s ease;
    }

    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      background: #f8fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-badge {
      background: #f1f5f9;
      color: var(--text-tertiary);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .panel-badge.active { background: #dcfce7; color: #166534; }
    .panel-badge.processing { background: #dbeafe; color: #1e40af; animation: pulse 2s ease-in-out infinite; }
    .panel-badge.warning { background: #fef3c7; color: #92400e; }

    /* AI Insights Panel */
    .insights-panel {
      position: sticky;
      top: 100px;
      max-height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
    }

    .insight-warning {
      border: 1px solid #fcd34d;
      background: #fffbeb;
      color: #92400e;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      font-size: 13px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .insights-content { padding: 24px; overflow-y: auto; flex: 1; }
    .insight-section { margin-bottom: 24px; animation: slideIn 0.4s ease; }
    .insight-section:last-child { margin-bottom: 0; }

    .insight-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .insight-icon { width: 20px; height: 20px; color: var(--accent-primary); }
    .insight-label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-tertiary); }

    .insight-content { font-size: 14px; line-height: 1.7; color: var(--text-secondary); }
    .insight-content.primary { color: var(--text-primary); font-size: 15px; }

    /* Match Quality Indicators */
    .match-quality { display: flex; flex-direction: column; gap: 12px; }
    .quality-bar { display: flex; align-items: center; gap: 12px; }
    .quality-label { font-size: 12px; font-weight: 600; color: var(--text-tertiary); min-width: 80px; }

    .quality-track {
      flex: 1;
      height: 8px;
      background: #f1f5f9;
      border-radius: 4px;
      overflow: hidden;
    }

    .quality-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .quality-fill.excellent { background: var(--excellent-match); }
    .quality-fill.good { background: var(--good-match); }
    .quality-fill.potential { background: var(--potential-match); }

    .quality-count { font-size: 13px; font-weight: 600; font-family: var(--font-mono); color: var(--text-primary); min-width: 32px; text-align: right; }

    /* Applied Filters Display */
    .filters-display { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-tag {
      background: #eff6ff;
      border: 1px solid #dbeafe;
      color: var(--accent-primary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .filter-tag-icon { width: 14px; height: 14px; }

    /* Panel Actions */
    .panel-actions {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 8px;
      background: #f8fafc;
    }

    .action-btn {
      background: white;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn:hover { border-color: var(--border-medium); color: var(--text-primary); }
    .action-icon { width: 14px; height: 14px; }

    /* Results Section */
    .results-section { animation: fadeIn 0.6s ease 0.2s backwards; }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 4px;
    }

    .results-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .results-actions { display: flex; gap: 8px; }

    /* Match Tier Groups */
    .tier-group { margin-bottom: 32px; }

    .tier-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: white;
      border-radius: var(--radius-md);
      border-left: 4px solid currentColor;
      box-shadow: var(--shadow-sm);
    }

    .tier-header.excellent { color: var(--excellent-match); }
    .tier-header.good { color: var(--good-match); }
    .tier-header.potential { color: var(--potential-match); }

    .tier-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .tier-title { font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; flex: 1; color: var(--text-primary); }

    .tier-count {
      font-size: 12px;
      font-family: var(--font-mono);
      font-weight: 600;
      background: #f1f5f9;
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
    }

    /* Profile Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    /* Profile Card */
    .profile-card {
      background: white;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }

    .profile-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-medium);
    }

    .card-header { display: flex; gap: 16px; margin-bottom: 16px; }
    .card-avatar-wrapper { position: relative; flex-shrink: 0; }

    .card-avatar {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      object-fit: cover;
      background: #f1f5f9;
      border: 1px solid var(--border-subtle);
    }

    .card-avatar-fallback {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
      font-size: 20px;
    }

    .card-info { flex: 1; min-width: 0; }

    .card-name {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-headline {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }

    .card-tag {
      background: #f1f5f9;
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .card-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .meta-row { display: flex; align-items: center; gap: 8px; }

    .card-match-reason {
      background: #f8fafc;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 16px;
    }

    .match-reason-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 700;
    }

    .match-reason-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    .card-actions {
      display: flex;
      gap: 10px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .card-action-btn {
      flex: 1;
      background: white;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      padding: 10px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      text-decoration: none;
      text-align: center;
    }

    .card-action-btn:hover { background: #f8fafc; color: var(--text-primary); border-color: var(--border-medium); }

    .card-action-btn.primary {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: var(--accent-primary);
    }

    .card-action-btn.primary:hover { background: #dbeafe; }

    /* Empty States */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px 40px;
      color: var(--text-tertiary);
    }

    .empty-icon { width: 64px; height: 64px; margin: 0 auto 20px; opacity: 0.2; color: var(--text-primary); }
    .empty-title { font-size: 18px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: var(--text-tertiary); }

    /* Loading */
    .loading-skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    .skeleton-text { height: 14px; margin-bottom: 8px; }
    .skeleton-title { height: 20px; width: 70%; margin-bottom: 12px; }
    .skeleton-avatar { width: 64px; height: 64px; border-radius: 12px; }
    .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }

    /* Responsive */
    @media (max-width: 1400px) { .content-grid { grid-template-columns: 380px 1fr; } }
    @media (max-width: 1200px) {
      .content-grid { grid-template-columns: 1fr; }
      .insights-panel { position: static; max-height: none; }
    }
    @media (max-width: 768px) {
      .header-stats { display: none; }
      .search-controls { flex-direction: column; align-items: stretch; }
      .control-group { justify-content: space-between; }
      .cards-grid { grid-template-columns: 1fr; }
      .results-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand-section">
        <div class="brand-logo">BMW TechWorks</div>
        <div class="brand-divider"></div>
        <div class="brand-tagline">Talent Intelligence</div>
        <a href="/web/architecture.html" class="nav-link-arch">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6" y2="6"></line><line x1="6" y1="18" x2="6" y2="18"></line></svg>
          App Architecture
        </a>
      </div>
      <div class="header-stats">
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <div>
            <div class="stat-label"><span class="stat-value" id="stat-retrieved">0</span> Retrieved</div>
            <div class="stat-subtext">Profiles</div>
          </div>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          <div>
            <div class="stat-label"><span class="stat-value" id="stat-pinecone">0.00s</span> Pinecone</div>
            <div class="stat-subtext">Vector search</div>
          </div>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20l9-16-9 7-9-7 9 16z"></path></svg>
          <div>
            <div class="stat-label"><span class="stat-value" id="stat-rerank">0.00s</span> Reranker</div>
            <div class="stat-subtext">Relevance boost</div>
          </div>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21l-8-4-8 4V5l8-4 8 4z"></path></svg>
          <div>
            <div class="stat-label"><span class="stat-value" id="stat-ai-latency">0.00s</span> AI Analysis</div>
            <div class="stat-subtext" id="stat-ai-tokens">0 in / 0 out</div>
          </div>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="7" height="7" rx="1"></rect><rect x="14" y="13" width="7" height="7" rx="1"></rect><path d="M10 8h4"></path><path d="M17 10v3"></path><path d="M7 14h3"></path></svg>
          <div>
            <div class="stat-label">LLM</div>
            <div class="stat-subtext" id="stat-llm-model">‚Äì</div>
          </div>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          <div>
            <div class="stat-label"><span class="stat-value" id="stat-latency">0.00s</span> Total</div>
            <div class="stat-subtext">Client roundtrip</div>
          </div>
        </div>
        <div class="stat-badge">DEMO</div>
        <a href="https://github.com/bogdan-ionut/bmw-techworks-rag-demo" target="_blank" class="github-link" title="View on GitHub">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-7.74-4.02-1.41 0 0-.525-1.335-1.275-1.605 0 0-1.005-.69.105-.675 0 0 1.11.075 1.695 1.155 1.05 1.785 2.76 1.275 3.435.975.105-.75.405-1.275.735-1.575-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405 1.02 0 2.04.135 3 .405 2.295-1.545 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.92 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.285 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <!-- Lockdown Overlay -->
  <div id="lockdownOverlay">
      <div class="lockdown-card">
          <div style="font-size: 56px; margin-bottom: 16px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">üéÑ‚ú®</div>
          <h2 class="lockdown-title">Santa's Secret Archive</h2>
          <p style="color: var(--text-secondary); line-height: 1.6; font-size: 16px; margin-bottom: 8px;">
              <strong>Ho Ho Ho!</strong> Only authorized elves with the magic key can view the Talent List.
          </p>
          <input type="password" id="lockdownPass" class="lockdown-input" placeholder="Enter the magic word..." />
          <button id="lockdownSubmit" class="lockdown-btn">üéÅ Open Archive</button>
          <div id="lockdownError" class="lockdown-error"></div>
      </div>
  </div>

  <div class="christmas-banner">
      <div class="snowflake" style="left: 15%; animation-duration: 8s; animation-delay: 0s;">‚ùÑÔ∏è</div>
      <div class="snowflake" style="left: 35%; animation-duration: 10s; animation-delay: 2s;">‚ùÑÔ∏è</div>
      <div class="snowflake" style="left: 55%; animation-duration: 12s; animation-delay: 4s;">‚ùÑÔ∏è</div>
      <div class="snowflake" style="left: 75%; animation-duration: 9s; animation-delay: 1s;">‚ùÑÔ∏è</div>
      <div class="snowflake" style="left: 85%; animation-duration: 11s; animation-delay: 3s;">‚ùÑÔ∏è</div>

      <div class="banner-content">
        <h2 class="banner-title">üéÑ Season's Greetings & Demo Disclaimer üéÑ</h2>
        <p class="banner-text">
          This project is <strong>solely for demonstration purposes</strong> for the technical interview with <strong>Ionut</strong> and <strong>Alexandru</strong>.<br>
          All data and functionality shown here are part of a proof-of-concept demo and will be deleted after the interview process.
        </p>
      </div>
  </div>
  <div class="search-section">
    <div class="search-card">
      <textarea id="searchInput" placeholder="Describe your ideal candidate... (e.g., 'Senior Machine Learning Engineers in Romania with NLP experience')"></textarea>
      <div class="search-controls">
          <div class="control-group">
            <div class="control-item">
              <label for="retrievalK">Retrieve:</label>
              <input id="retrievalK" type="number" min="1" max="32" step="1" value="6" />
            </div>
            <div class="control-item llm-selector">
              <label for="llmModel">LLM Model</label>
              <select id="llmModel">
                <!-- Populated by script -->
              </select>
            </div>
            <div class="control-item">
              <label for="plannerToggle">Query Planner</label>
              <label class="toggle">
                <input type="checkbox" id="plannerToggle" checked />
                <div class="toggle-slider"></div>
              </label>
            </div>
            <div class="control-item">
              <label for="aiToggle">AI Analysis</label>
              <label class="toggle">
                <input type="checkbox" id="aiToggle" />
                <div class="toggle-slider"></div>
              </label>
            </div>
          </div>
        <button class="btn-primary" id="searchBtn">
          <span id="searchBtnText">Search Profiles</span>
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Search Tools Tabs -->
  <div class="search-tools-container">
    <div class="tabs-header">
      <button class="tab-btn active" data-tab="presets">Proposed Searches</button>
      <button class="tab-btn" data-tab="metadata">Search Metadata</button>
      <button class="tab-btn" data-tab="visuals">Visual Filters</button>
    </div>

    <div class="tabs-content">
      <!-- Tab 1: Proposed Searches -->
      <div class="tab-pane active" id="tab-presets">
        <div class="quick-filters">
          <div class="filter-chip" data-query="Senior Python Engineers who are wearing eyeglasses">üëì Python & Glasses</div>
          <div class="filter-chip" data-query="Senior Java Developers with AWS cloud experience and microservices architecture skills">‚òÅÔ∏è Java Cloud Architects</div>
          <div class="filter-chip" data-query="Scrum Masters with a technical background in software development">üîÑ Technical Scrum Masters</div>
          <div class="filter-chip" data-query="HR Specialists focused on IT recruitment and talent sourcing in Cluj">ü§ù Tech Talent Acquisition</div>
        </div>
      </div>

      <!-- Tab 2: Metadata -->
      <div class="tab-pane" id="tab-metadata">
        <div class="smart-filters">
          <div class="smart-filter-chip metadata-chip" data-val="Python">Python</div>
          <div class="smart-filter-chip metadata-chip" data-val="Java">Java</div>
          <div class="smart-filter-chip metadata-chip" data-val="C++">C++</div>
          <div class="smart-filter-chip metadata-chip" data-val="React">React</div>
          <div class="smart-filter-chip metadata-chip" data-val="Node.js">Node.js</div>
          <div class="smart-filter-chip metadata-chip" data-val="AWS">AWS</div>
          <div class="smart-filter-chip metadata-chip" data-val="Machine Learning">Machine Learning</div>
          <div class="smart-filter-chip metadata-chip" data-val="Romania">Romania</div>
          <div class="smart-filter-chip metadata-chip" data-val="Munich">Munich</div>
          <div class="smart-filter-chip metadata-chip" data-val="Senior">Senior</div>
          <div class="smart-filter-chip metadata-chip" data-val="Lead">Lead</div>
        </div>
      </div>

      <!-- Tab 3: Visual Filters -->
      <div class="tab-pane" id="tab-visuals">
        <div class="smart-filters">
          <div class="smart-filter-chip" data-filter="Beard">Beard</div>
          <div class="smart-filter-chip" data-filter="Glasses">Glasses</div>
          <div class="smart-filter-chip" data-filter="Tie">Tie</div>
          <div class="smart-filter-chip" data-filter="Suit">Suit</div>
          <div class="smart-filter-chip" data-filter="Blazer">Blazer</div>
          <div class="smart-filter-chip" data-filter="T-Shirt">T-Shirt</div>
          <div class="smart-filter-chip" data-filter="Short Hair">Short Hair</div>
          <div class="smart-filter-chip" data-filter="Long Hair">Long Hair</div>
          <div class="smart-filter-chip" data-filter="Blonde">Blonde</div>
          <div class="smart-filter-chip" data-filter="Dark Hair">Dark Hair</div>
          <div class="smart-filter-chip" data-filter="Grey Hair">Grey Hair</div>
          <div class="smart-filter-chip" data-filter="Headshot">Headshot</div>
        </div>
      </div>
    </div>
  </div>

  <main class="main-container">
    <div class="content-grid">
      <div class="panel insights-panel">
        <div class="panel-header">
          <div class="panel-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
            AI Intelligence
          </div>
          <div class="panel-badge" id="insightStatus">Idle</div>
        </div>
        <div class="insights-content" id="insightsContent">
          <div class="empty-state" style="padding: 40px 20px;">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <div class="empty-title">AI Analysis Ready</div>
            <div class="empty-text">Run a search to see intelligent insights about candidates</div>
          </div>
        </div>
        <div class="panel-actions" id="insightActions" style="display: none;">
          <button class="action-btn" id="copyInsights">
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
            Copy
          </button>
        </div>
      </div>

      <div class="results-section">
        <div class="results-header">
          <div class="results-title">Candidate Matches</div>
          <div class="results-actions">
            </div>
        </div>
        <div id="resultsContainer">
          <div class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <div class="empty-title">No Results Yet</div>
            <div class="empty-text">Enter a search query above to find matching candidates</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // State management
    let currentResults = null;
    let currentInsights = null;
    let abortController = null;
    let selectedSmartFilters = new Set();
    let selectedMetadata = new Set();
    let selectedProposedChip = null;

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchBtnText = document.getElementById('searchBtnText');
    const retrievalK = document.getElementById('retrievalK');
    const llmModelSelect = document.getElementById('llmModel');
    const aiToggle = document.getElementById('aiToggle');
    const plannerToggle = document.getElementById('plannerToggle');
    const insightsContent = document.getElementById('insightsContent');
    const insightStatus = document.getElementById('insightStatus');
    const insightActions = document.getElementById('insightActions');
    const resultsContainer = document.getElementById('resultsContainer');
    const statRetrieved = document.getElementById('stat-retrieved');
    const statPinecone = document.getElementById('stat-pinecone');
    const statRerank = document.getElementById('stat-rerank');
    const statAiLatency = document.getElementById('stat-ai-latency');
    const statAiTokens = document.getElementById('stat-ai-tokens');
    const statLlmModel = document.getElementById('stat-llm-model');
    const statLatency = document.getElementById('stat-latency');
    const copyInsightsBtn = document.getElementById('copyInsights');

    // Tabs Logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove active class from all buttons and panes
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

        // Add active class to clicked button and corresponding pane
        btn.classList.add('active');
        const tabId = btn.dataset.tab;
        document.getElementById(`tab-${tabId}`).classList.add('active');
      });
    });

    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '?';
    }

    function getMatchTier(score) {
      if (score >= 0.85) return { tier: 'excellent', label: 'Excellent Match', icon: '‚òÖ' };
      if (score >= 0.75) return { tier: 'good', label: 'Good Match', icon: '‚óÜ' };
      return { tier: 'potential', label: 'Potential Match', icon: '‚óã' };
    }

    function sanitizeRetrievalValue(defaultValue = 6) {
      const trimmedValue = retrievalK.value.trim();
      if (trimmedValue === '') {
        retrievalK.value = defaultValue;
        return defaultValue;
      }
      let val = parseInt(trimmedValue, 10);
      if (Number.isNaN(val) || val < 1 || val > 32) {
        val = defaultValue;
      }
      retrievalK.value = val;
      return val;
    }

    function resolveAvatarUrl(profile) {
      const img = (profile.profile_image_url || profile.profile_image_s3_url || '').trim();
      if (!img) return null;
      if (img.includes('media.licdn.com')) {
        return `https://images.weserv.nl/?url=${encodeURIComponent(img.replace(/^https?:\/\//, ''))}&w=320&h=320&fit=cover`;
      }
      return img;
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      }
    }

    // Render functions
    function renderInsights(data) {
      const answer = data.answer || {};
      const answerText = answer.answer || data.answer_text || (typeof answer === 'string' ? answer : '');
      const filtersApplied = answer.filters_applied || data.filters_applied;
      const fallbackReason = data.llm_fallback_reason || '';

      const sources = data.sources || [];
      const tierCounts = { excellent: 0, good: 0, potential: 0 };
      sources.forEach(s => {
        const { tier } = getMatchTier(s.score || 0);
        tierCounts[tier]++;
      });

      let html = '';

      if (fallbackReason) {
        const fallbackMessageMap = {
          unstructured_output: 'Model response was unstructured. Showing the best-effort raw analysis instead of dropping insights.',
          llm_fallback: 'Model response could not be parsed. Showing a safe fallback based on retrieved matches.',
          llm_invoke_failed: 'Model call failed. Showing a safe fallback based on retrieved matches.',
        };
        const fallbackMessage = fallbackMessageMap[fallbackReason] || 'AI output degraded; showing safe fallback.';
        html += `
          <div class="insight-warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4"></path><path d="M12 17h.01"></path><path d="M10.29 3.86L1.82 18a1.65 1.65 0 001.42 2.48h17.52A1.65 1.65 0 0022.18 18L13.71 3.86a1.65 1.65 0 00-2.82 0z"></path></svg>
            <div><strong>Degraded AI output</strong><br>${fallbackMessage}</div>
          </div>
        `;
      }


      // Applied Filters
      if (filtersApplied && Object.keys(filtersApplied).length > 0) {
        html += `
          <div class="insight-section">
            <div class="insight-header">
              <svg class="insight-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path>
              </svg>
              <span class="insight-label">Applied Filters</span>
            </div>
            <div class="filters-display">
        `;

        // Handle MongoDB style filters if present (simplified visualization)
        if (filtersApplied['$and']) {
            filtersApplied['$and'].forEach(f => {
                const [k, v] = Object.entries(f)[0];
                const valStr = typeof v === 'object' ? JSON.stringify(v) : v;
                html += `
                  <div class="filter-tag">
                    <svg class="filter-tag-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"></path></svg>
                    ${k}: ${valStr}
                  </div>`;
            });
        } else {
            Object.entries(filtersApplied).forEach(([k, v]) => {
                const valStr = typeof v === 'object' ? JSON.stringify(v) : v;
                 html += `
                  <div class="filter-tag">
                    <svg class="filter-tag-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"></path></svg>
                    ${k}: ${valStr}
                  </div>`;
            });
        }

        html += `
            </div>
          </div>
        `;
      }

      // AI Analysis Text
      if (answerText) {
          html += `
            <div class="insight-section">
              <div class="insight-header">
                <svg class="insight-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                <span class="insight-label">AI Analysis</span>
              </div>
              <div class="insight-content primary">
                ${escapeHtml(answerText).replace(/\n/g, '<br>')}
              </div>
            </div>
          `;
      }

      insightsContent.innerHTML = html;
      if (fallbackReason) {
        insightStatus.textContent = "Degraded";
        insightStatus.className = "panel-badge warning";
      } else {
        insightStatus.textContent = "Ready";
        insightStatus.className = "panel-badge active";
      }
      insightActions.style.display = "flex";
      currentInsights = answerText;
    }

    function renderResults(data) {
        const sources = data.sources || [];

        if (sources.length === 0) {
            resultsContainer.innerHTML = `
              <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M10 21h4a2 2 0 002-2v-1.28a1 1 0 00-.2-.64l-1.92-2.56a1 1 0 010-1.28l1.92-2.56a1 1 0 00.2-.64V8a2 2 0 00-2-2h-4a2 2 0 00-2 2v1.28a1 1 0 00.2.64l1.92 2.56a1 1 0 010 1.28l-1.92 2.56a1 1 0 00-.2.64V19a2 2 0 002 2z"></path>
                </svg>
                <div class="empty-title">No Matches Found</div>
                <div class="empty-text">Try adjusting your search criteria</div>
              </div>
            `;
            return;
        }

        // Group by tier
        const tiers = { excellent: [], good: [], potential: [] };
        sources.forEach(s => {
            const { tier } = getMatchTier(s.score || 0);
            tiers[tier].push(s);
        });

        let html = '';

        const tierConfig = {
            excellent: { title: 'Excellent Matches', icon: '‚òÖ', class: 'excellent' },
            good: { title: 'Good Matches', icon: '‚óÜ', class: 'good' },
            potential: { title: 'Potential Matches', icon: '‚óã', class: 'potential' }
        };

        Object.entries(tierConfig).forEach(([tierKey, config]) => {
            const candidates = tiers[tierKey];
            if (candidates.length === 0) return;

            html += `
              <div class="tier-group">
                <div class="tier-header ${config.class}">
                  <span class="tier-icon" style="display:flex;align-items:center;justify-content:center;font-size:16px;">${config.icon}</span>
                  <span class="tier-title">${config.title}</span>
                  <span class="tier-count">${candidates.length}</span>
                </div>
                <div class="cards-grid">
            `;

            candidates.forEach(profile => {
                const avatarUrl = resolveAvatarUrl(profile);
                const initials = getInitials(profile.full_name);
                const scorePct = Math.round((profile.score || 0) * 100);

                html += `
                  <div class="profile-card ${config.class}" onclick="window.open('${escapeHtml(profile.profile_url)}', '_blank')">
                    <div class="card-header">
                      <div class="card-avatar-wrapper">
                        ${avatarUrl
                          ? `<img src="${avatarUrl}" class="card-avatar" alt="${escapeHtml(profile.full_name)}"/>`
                          : `<div class="card-avatar-fallback">${initials}</div>`
                        }
                      </div>
                      <div class="card-info">
                        <div class="card-name">${escapeHtml(profile.full_name)}</div>
                        <div class="card-headline">${escapeHtml(profile.headline)}</div>
                      </div>
                    </div>

                    <div class="card-tags">
                       ${profile.job_title ? `<span class="card-tag">${escapeHtml(profile.job_title)}</span>` : ''}
                       ${profile.location ? `<span class="card-tag">üìç ${escapeHtml(profile.location)}</span>` : ''}
                    </div>

                    <div class="card-meta">
                        ${profile.school ? `<div class="meta-row">üéì ${escapeHtml(profile.school)}</div>` : ''}
                        ${profile.company ? `<div class="meta-row">üè¢ ${escapeHtml(profile.company)}</div>` : ''}
                    </div>

                    ${profile.reasoning ? `
                    <div class="card-match-reason">
                      <div class="match-reason-label">Why this match?</div>
                      <div class="match-reason-text">${escapeHtml(profile.reasoning)}</div>
                    </div>` : ''}

                    <div class="card-actions">
                        <a href="${escapeHtml(profile.profile_url)}" target="_blank" class="card-action-btn primary" onclick="event.stopPropagation()">LinkedIn</a>
                        <button class="card-action-btn" onclick="event.stopPropagation(); copyToClipboard('${escapeHtml(profile.profile_url)}')">Copy Link</button>
                    </div>
                  </div>
                `;
            });

            html += `
                </div>
              </div>
            `;
        });

        resultsContainer.innerHTML = html;
    }

    async function handleSearch() {
        let query = searchInput.value.trim();

        // Allow search if we have text input OR any selected filters
        if (!query && selectedMetadata.size === 0 && selectedSmartFilters.size === 0) {
            return;
        }

        // Append metadata to query
        if (selectedMetadata.size > 0) {
            const meta = Array.from(selectedMetadata).join(' ');
            // If query is not empty, add a space. If empty, just set it to meta.
            query = query ? `${query} ${meta}` : meta;
        }

        // Append visual filters to query
        if (selectedSmartFilters.size > 0) {
            const filters = Array.from(selectedSmartFilters).join(', ');
            // If query (including metadata) is not empty, append " with ..."
            // If query is still empty, append "with ..." or just the filters?
            // "with Glasses" is semantically clearer for the embedding model than just "Glasses" (which might match the word Glasses)
            query = query ? `${query} with ${filters}` : `with ${filters}`;
        }

        if (abortController) abortController.abort();
        abortController = new AbortController();
        const signal = abortController.signal;

        searchBtn.disabled = true;
        searchBtnText.innerHTML = '<div class="spinner"></div>';
        insightStatus.textContent = "Retrieving...";
        insightStatus.className = "panel-badge processing";

        // Render skeletons for both panels
        insightsContent.innerHTML = `<div class="loading-skeleton skeleton-title"></div><div class="loading-skeleton skeleton-text"></div><div class="loading-skeleton skeleton-text"></div>`;
        resultsContainer.innerHTML = `<div class="cards-grid">${Array(4).fill(0).map(() => `<div class="profile-card"><div class="card-header"><div class="loading-skeleton skeleton-avatar"></div><div class="card-info"><div class="loading-skeleton skeleton-title"></div><div class="loading-skeleton skeleton-text"></div></div></div><div class="loading-skeleton skeleton-text"></div></div>`).join('')}</div>`;

        const startTime = performance.now();
        const k = sanitizeRetrievalValue();
        const useAi = aiToggle.checked;
        const usePlanner = plannerToggle.checked;
        const selectedLlmOption = llmModelSelect?.selectedOptions?.[0] || llmModelSelect?.options?.[llmModelSelect.selectedIndex];
        const llmModel = selectedLlmOption?.value;
        const llmProvider = selectedLlmOption?.dataset?.provider;

        try {
            // Step 1: Fetch search results first (fast)
            const searchRes = await fetch(`/search?q=${encodeURIComponent(query)}&k=${k}&planner=${usePlanner}`, { signal });
            if (!searchRes.ok) throw new Error(await searchRes.text());
            const searchData = await searchRes.json();

            // Update stats from search
            statRetrieved.textContent = searchData.retrieved_docs || 0;
            const pineconeSec = Number(searchData.retrieval_sec ?? 0);
            statPinecone.textContent = `${pineconeSec.toFixed(2)}s`;
            statRerank.textContent = `${(searchData.rerank_sec ?? 0).toFixed(2)}s`;
            statLatency.textContent = `${((performance.now() - startTime) / 1000).toFixed(2)}s`;

            // Render search results immediately
            renderResults(searchData);

            if (useAi) {
                insightStatus.textContent = "AI Analyzing...";
                insightStatus.className = "panel-badge processing";

                // Step 2: Fetch AI insights (slow, can be aborted)
                const aiRes = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        k,
                        with_llm: true,
                        planner: usePlanner,
                        sources: searchData.sources, // Pass sources to skip retrieval
                        llm_provider: llmProvider,
                        llm_model: llmModel,
                    }),
                    signal
                });

                if (!aiRes.ok) throw new Error(await aiRes.text());
                const aiData = await aiRes.json();

                // Update remaining stats
                const aiLatency = Number(aiData.llm_sec ?? 0);
                const promptTokens = Number(aiData.llm_prompt_tokens ?? 0);
                const completionTokens = Number(aiData.llm_completion_tokens ?? 0);
                const totalTokens = Number(aiData.llm_total_tokens ?? (promptTokens + completionTokens));

                statAiLatency.textContent = `${aiLatency.toFixed(2)}s`;
                statAiTokens.textContent = `${promptTokens} in / ${completionTokens} out (${totalTokens} total)`;
                const llmUsed = aiData.llm_used || '';
                const llmModelLabel = aiData.llm_model || '';
                statLlmModel.textContent = llmModelLabel
                  ? `${llmUsed ? `${llmUsed} ‚Ä¢ ` : ''}${llmModelLabel}`
                  : (llmUsed || '‚Äî');
                statLatency.textContent = `${((performance.now() - startTime) / 1000).toFixed(2)}s`;

                renderInsights(aiData);
            } else {
                insightsContent.innerHTML = `<div class="empty-state" style="padding: 40px 20px;"><div class="empty-title">AI Analysis Disabled</div><div class="empty-text">Enable the AI toggle to generate insights</div></div>`;
                insightStatus.textContent = "Disabled";
                insightStatus.className = "panel-badge";
                insightActions.style.display = "none";
            }
        } catch (err) {
            if (err.name === 'AbortError') {
              console.log('Search aborted.');
              return;
            }
            console.error(err);
            resultsContainer.innerHTML = `<div class="empty-state"><div class="empty-title">An Error Occurred</div><div class="empty-text">${escapeHtml(err.message)}</div></div>`;
            insightsContent.innerHTML = `<div class="empty-state"><div class="empty-title">Error</div><div class="empty-text">${escapeHtml(err.message)}</div></div>`;
            insightStatus.textContent = "Error";
            insightStatus.className = "panel-badge warning";
        } finally {
            searchBtn.disabled = false;
            searchBtnText.textContent = "Search Profiles";
        }
    }

    async function populateLlmSelector() {
      try {
        const res = await fetch('/meta');
        if (!res.ok) throw new Error('Failed to fetch metadata');
        const meta = await res.json();

        const llms = meta.available_llms || {};
        const defaultOpenai = meta.openai_model || '';
        const defaultGemini = meta.gemini_model || '';

        let html = '';

        if (llms.OPENAI) {
          html += `<optgroup label="OpenAI">`;
          llms.OPENAI.forEach(m => {
            const isSelected = m.value === defaultOpenai ? 'selected' : '';
            html += `<option value="${escapeHtml(m.value)}" data-provider="OPENAI" ${isSelected}>${escapeHtml(m.name)}</option>`;
          });
          html += `</optgroup>`;
        }

        if (llms.GEMINI) {
          html += `<optgroup label="Google Gemini">`;
          llms.GEMINI.forEach(m => {
            const isSelected = m.value === defaultGemini ? 'selected' : '';
            html += `<option value="${escapeHtml(m.value)}" data-provider="GEMINI" ${isSelected}>${escapeHtml(m.name)}</option>`;
          });
          html += `</optgroup>`;
        }

        llmModelSelect.innerHTML = html;
      } catch (e) {
        console.error("Could not populate LLM selector:", e);
        llmModelSelect.innerHTML = `<option value="">Error loading models</option>`;
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth status by hitting a protected endpoint
      try {
          const check = await fetch('/meta');
          if (check.status === 403) {
              document.getElementById('lockdownOverlay').style.display = 'block';
          } else {
              populateLlmSelector();
          }
      } catch (e) {
          console.error("Auth check failed", e);
      }
    });

    // Lockdown Logic
    const lockdownSubmit = document.getElementById('lockdownSubmit');
    const lockdownPass = document.getElementById('lockdownPass');
    const lockdownError = document.getElementById('lockdownError');

    async function handleUnlock() {
        const pwd = lockdownPass.value;
        if (!pwd) return;

        lockdownSubmit.disabled = true;
        lockdownSubmit.textContent = "Verifying...";
        lockdownError.textContent = "";

        try {
            const res = await fetch('/auth/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: pwd })
            });

            if (res.ok) {
                document.getElementById('lockdownOverlay').style.display = 'none';
                populateLlmSelector(); // Load the data we couldn't get before
            } else {
                lockdownError.textContent = "Incorrect password. The Grinch blocks the way!";
            }
        } catch (e) {
            lockdownError.textContent = "Connection error.";
        } finally {
            lockdownSubmit.disabled = false;
            lockdownSubmit.textContent = "Unlock";
        }
    }

    lockdownSubmit.addEventListener('click', handleUnlock);
    lockdownPass.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleUnlock();
    });

    retrievalK.addEventListener('blur', () => sanitizeRetrievalValue());

    searchBtn.addEventListener('click', handleSearch);

    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSearch();
        }
    });

    // Handle user typing: deselect proposed search if text changes from the preset?
    // Actually, simply deselecting the chip visually is enough to indicate custom input.
    searchInput.addEventListener('input', () => {
        if (selectedProposedChip) {
            selectedProposedChip.classList.remove('selected');
            selectedProposedChip = null;
        }
    });

    // Proposed Searches (Selectable)
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            // Deselect previous
            if (selectedProposedChip) {
                selectedProposedChip.classList.remove('selected');
            }

            // If clicking the same one, toggle off
            if (selectedProposedChip === chip) {
                selectedProposedChip = null;
                searchInput.value = ''; // Clear or keep? Let's clear to reset.
            } else {
                // Select new
                selectedProposedChip = chip;
                chip.classList.add('selected');
                searchInput.value = chip.dataset.query;
            }
            // Do NOT trigger handleSearch() immediately
        });
    });

    // Metadata Filters
    document.querySelectorAll('.metadata-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const val = chip.dataset.val;
            chip.classList.toggle('selected');
            if (selectedMetadata.has(val)) {
                selectedMetadata.delete(val);
            } else {
                selectedMetadata.add(val);
            }
        });
    });

    // Visual Filters
    document.querySelectorAll('.smart-filter-chip:not(.metadata-chip)').forEach(chip => {
        chip.addEventListener('click', () => {
            const filter = chip.dataset.filter;
            chip.classList.toggle('selected');
            if (selectedSmartFilters.has(filter)) {
                selectedSmartFilters.delete(filter);
            } else {
                selectedSmartFilters.add(filter);
            }
        });
    });

    if (copyInsightsBtn) {
        copyInsightsBtn.addEventListener('click', async () => {
            if (currentInsights) {
                await copyToClipboard(currentInsights);
                const originalText = copyInsightsBtn.innerHTML;
                copyInsightsBtn.innerHTML = `
                  <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                  Copied
                `;
                setTimeout(() => {
                    copyInsightsBtn.innerHTML = originalText;
                }, 2000);
            }
        });
    }
  </script>
</body>
</html>

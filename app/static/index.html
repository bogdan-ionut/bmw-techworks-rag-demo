<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMW TechWorks ‚Ä¢ Talent Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #020617;
        --panel: rgba(15, 23, 42, 0.72);
        --panel-soft: rgba(30, 41, 59, 0.5);
        --border: rgba(148, 163, 184, 0.16);
        --text: #e2e8f0;
        --muted: #94a3b8;
        --accent: #3b82f6;
        --accent-2: #06b6d4;
        --accent-glow: rgba(59, 130, 246, 0.25);
        --radius: 20px;
        --shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Plus Jakarta Sans", -apple-system, system-ui, sans-serif;
        background-color: var(--bg-dark);
        background-image:
          radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.14) 0px, transparent 45%),
          radial-gradient(at 100% 0%, rgba(6, 182, 212, 0.14) 0px, transparent 45%),
          radial-gradient(at 40% 100%, rgba(109, 40, 217, 0.12) 0px, transparent 50%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 26px 5vw 18px;
        backdrop-filter: blur(12px);
        background: rgba(2, 6, 23, 0.9);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand-area { display: flex; align-items: center; gap: 12px; }
      .brand { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
      .badge {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.22));
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #bfdbfe;
        border: 1px solid var(--border);
      }

      .meta { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; }
      .meta span { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); }

      .hero { padding: 14px 5vw 10px; display: grid; gap: 10px; max-width: 1400px; width: 100%; margin: 0 auto; }
      .hero h1 { margin: 0; font-size: 26px; letter-spacing: -0.4px; }
      .hero p { margin: 0; color: var(--muted); max-width: 880px; line-height: 1.6; }

      .search { width: 100%; max-width: 1200px; margin: 20px auto 10px; padding: 0 5vw; }
      .input-wrap {
        display: flex;
        gap: 12px;
        padding: 10px;
        background: rgba(15, 23, 42, 0.75);
        border-radius: 22px;
        border: 1px solid var(--border);
        box-shadow: 0 0 0 1px transparent, 0 30px 70px rgba(0,0,0,0.55);
        transition: all 0.25s ease;
      }
      .input-wrap:focus-within { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent), 0 25px 60px rgba(59,130,246,0.2); }

      textarea {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--text);
        font-size: 16px;
        padding: 12px 14px;
        resize: none;
        min-height: 64px;
        outline: none;
      }

      .actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }

      button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: white;
        border: none;
        padding: 14px 22px;
        border-radius: 16px;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 12px 32px var(--accent-glow);
        transition: transform 0.15s ease, opacity 0.15s ease;
      }
      button.primary:disabled { opacity: 0.6; cursor: wait; }
      button.primary:hover { opacity: 0.95; }
      button.primary:active { transform: translateY(1px); }

      .chips { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 5vw 0; max-width: 1200px; margin: 0 auto; }
      .chip {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chip:hover { background: rgba(255,255,255,0.08); color: white; border-color: rgba(59,130,246,0.4); }

      main { flex: 1; padding: 24px 5vw 60px; max-width: 1600px; width: 100%; margin: 0 auto; }
      .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 20px; align-items: start; }

      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(12px); }
      .panel-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
      .panel-title { text-transform: uppercase; letter-spacing: 0.12em; font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 10px; }
      .pill { padding: 8px 12px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); font-size: 12px; color: var(--muted); }

      .panel-body { padding: 18px 20px 22px; }
      .answer { color: var(--text); line-height: 1.7; font-size: 15px; white-space: pre-wrap; }
      .answer.placeholder { color: var(--muted); }

      .toolbar { display: flex; align-items: center; justify-content: flex-end; gap: 10px; padding: 0 20px 12px; color: var(--muted); font-size: 12px; }
      .ghost-btn { border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--text); padding: 8px 12px; border-radius: 12px; font-weight: 700; cursor: pointer; }

      .profiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; padding: 16px 18px 20px; }
      .card { background: var(--panel-soft); border: 1px solid var(--border); border-radius: 16px; padding: 14px; display: grid; gap: 12px; box-shadow: 0 18px 36px rgba(0,0,0,0.35); transition: transform 0.18s ease, border-color 0.18s ease; }
      .card:hover { transform: translateY(-2px); border-color: rgba(59,130,246,0.4); }
      .card-top { display: flex; gap: 12px; align-items: center; }
      .avatar { width: 58px; height: 58px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); background: #1f2937; flex-shrink: 0; }
      .avatar-fallback { width: 58px; height: 58px; border-radius: 50%; background: linear-gradient(135deg, #475569, #334155); color: white; display: grid; place-items: center; font-weight: 800; font-size: 18px; border: 2px solid rgba(255,255,255,0.1); flex-shrink: 0; }
      .card h3 { margin: 0; font-size: 16px; }
      .headline { margin: 2px 0 0; font-size: 12px; color: var(--muted); line-height: 1.4; }
      .tags { display: flex; flex-wrap: wrap; gap: 6px; }
      .tag { background: rgba(59,130,246,0.12); color: #bfdbfe; padding: 6px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; border: 1px solid rgba(59,130,246,0.2); }
      .meta-row { display: grid; gap: 6px; color: var(--muted); font-size: 12px; }
      .meta-row span { display: inline-flex; gap: 6px; align-items: center; }
      .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
      .mini-btn { border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text); padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; }
      .mini-btn.primary { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.12); color: #cbd5f5; }

      .empty { color: var(--muted); font-size: 14px; text-align: center; padding: 24px; grid-column: 1/-1; }

      @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } header { position: static; } }
    </style>
  </head>
  <body>
    <header>
      <div class="brand-area">
        <div class="brand">BMW TechWorks</div>
        <div class="badge">Talent Intelligence</div>
      </div>
      <div class="meta">
        <span id="meta-model">Model: ‚Äî</span>
        <span id="meta-docs">Docs: ‚Äî</span>
        <span id="meta-time">Latency: ‚Äî</span>
        <span id="meta-uniq">Cards: ‚Äî</span>
      </div>
    </header>

    <div class="hero">
      <h1>RƒÉspunsuri clare, carduri aerisite</h1>
      <p>Interfa»õƒÉ dedicatƒÉ pentru √ÆntrebƒÉri de tip interview: roluri, tehnologie, educa»õie sau loca»õie. RƒÉspunsurile AI »ôi cardurile deduplicate sunt livrate √Æntr-un format pregƒÉtit pentru demo.</p>
    </div>

    <div class="search">
      <div class="input-wrap">
        <textarea id="q" placeholder="Ex: Cine sunt Infrastructure Engineers »ôi unde sunt localiza»õi?"></textarea>
        <div class="actions">
          <button class="primary" id="ask" type="button">
            <span id="btn-text">GenereazƒÉ</span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          </button>
            <small id="status" style="color: var(--muted); font-size: 12px;">PregƒÉtit</small>
        </div>
      </div>
    </div>

    <div class="chips">
      <div class="chip" data-q="Cine sunt Infrastructure Engineers? AratƒÉ-mi poza »ôi rolul.">Infrastructure Engineers</div>
      <div class="chip" data-q="GƒÉse»ôte masteranzi la UBB care lucreazƒÉ la noi.">Masteranzi UBB</div>
      <div class="chip" data-q="Cine are 'Java' sau 'Python' √Æn headline?">Skill: Java/Python</div>
      <div class="chip" data-q="C√¢»õi oameni sunt pe roluri de Software Engineer?">Statistici Software</div>
    </div>

    <main>
      <div class="grid">
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">AI Analysis</div>
            <div class="pill" id="answer-hint">PregƒÉtit pentru √Æntrebare</div>
          </div>
          <div class="toolbar">
            <button class="ghost-btn" id="copy-answer">Copy answer</button>
          </div>
          <div class="panel-body">
            <div class="answer placeholder" id="answer">RƒÉspunsul va apƒÉrea aici dupƒÉ ce adresezi o √Æntrebare.</div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Identified Profiles</div>
            <div class="pill" id="card-count">0 carduri</div>
          </div>
          <div class="profiles-grid" id="profiles">
            <div class="empty">Niciun profil √ÆncƒÉrcat.</div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const askBtn = document.getElementById("ask");
      const btnText = document.getElementById("btn-text");
      const qEl = document.getElementById("q");
      const answerEl = document.getElementById("answer");
      const answerHint = document.getElementById("answer-hint");
      const profilesEl = document.getElementById("profiles");
      const cardCountEl = document.getElementById("card-count");
      const copyAnswerBtn = document.getElementById("copy-answer");
      const statusEl = document.getElementById("status");

      const metaModel = document.getElementById("meta-model");
      const metaDocs = document.getElementById("meta-docs");
      const metaTime = document.getElementById("meta-time");
      const metaUniq = document.getElementById("meta-uniq");

      let lastAnswerRaw = "";
      let abortController = null;

      const fallbackAvatar = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop stop-color='#3b82f6' offset='0%'/>
              <stop stop-color='#06b6d4' offset='100%'/>
            </linearGradient>
          </defs>
          <rect width='64' height='64' rx='16' fill='url(#g)' />
          <circle cx='32' cy='28' r='14' fill='rgba(255,255,255,0.35)' />
          <rect x='14' y='44' width='36' height='14' rx='7' fill='rgba(255,255,255,0.35)' />
        </svg>
      `)}`;

      function escapeHtml(str = "") {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function normalizeLinkedIn(url = "") {
        const clean = url.trim().split(/[?#]/)[0].replace(/\/$/, "");
        try {
          const parsed = new URL(clean.toLowerCase());
          const host = parsed.hostname.endsWith("linkedin.com")
            ? "linkedin.com"
            : parsed.hostname;
          const path = parsed.pathname.startsWith("/in/")
            ? parsed.pathname
            : `/in/${parsed.pathname.replace(/^\//, "")}`;
          return `https://${host}${path.replace(/\/$/, "")}`;
        } catch (e) {
          return clean.toLowerCase();
        }
      }

      function canonicalVmid(vmid) {
        if (!vmid) return "";
        return String(vmid).trim().toLowerCase().replace(/[^a-z0-9]/g, "");
      }

      function sourceKey(s) {
        const vmid = canonicalVmid(s.vmid);
        const profile = normalizeLinkedIn(s.profile_url || "");
        const name = (s.full_name || "").trim().toLowerCase();
        const sourceId = (s.source_id || "").trim().toLowerCase();
        return vmid || profile || name || sourceId || JSON.stringify(s);
      }

      function completenessScore(s) {
        let score = 0;
        const weighted = {
          profile_image_url: 3,
          profile_url: 2,
          headline: 2,
          job_title: 2,
          location: 2,
          job_title_2: 1,
          school: 1,
          school_2: 1,
        };
        for (const [k, weight] of Object.entries(weighted)) {
          if (s[k]) score += weight;
        }
        score += Object.values(s).filter((v) => v !== null && v !== "" && v !== undefined).length;
        return score;
      }

      function mergeSources(a, b) {
        const pickBase = completenessScore(b) > completenessScore(a) ? [b, a] : [a, b];
        const [base, secondary] = pickBase.map((x) => ({ ...x }));
        for (const [k, v] of Object.entries(secondary)) {
          if (base[k] === undefined || base[k] === null || base[k] === "") base[k] = v;
        }
        return base;
      }

      function dedupeSources(sources) {
        const map = new Map();
        for (const s of sources || []) {
          const key = sourceKey(s);
          if (!key) continue;
          if (!map.has(key)) map.set(key, s);
          else map.set(key, mergeSources(map.get(key), s));
        }
        return Array.from(map.values());
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function formatAnswer(raw) {
        return escapeHtml(raw || "").replace(/\n/g, "<br>");
      }

      function getInitials(name = "") {
        return name
          .split(" ")
          .filter(Boolean)
          .map((n) => n[0])
          .join("")
          .substring(0, 2)
          .toUpperCase() || "?";
      }

      function resolveAvatarSrc(s) {
        const img = (s.profile_image_url || "").trim();
        if (!img) return fallbackAvatar;
        const linkedinImg = normalizeLinkedIn(img).includes("media.licdn.com");
        if (linkedinImg) {
          const proxied = `https://images.weserv.nl/?url=${encodeURIComponent(img.replace(/^https?:\/\//, ""))}&w=320&h=320&fit=cover`;
          return proxied;
        }
        return escapeHtml(img);
      }

      function buildCard(s, idx) {
        const avatar = resolveAvatarSrc(s);
        const initials = getInitials(s.full_name);
        const profileUrl = s.profile_url || "";
        const vmid = s.vmid || "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-top">
            <div style="position:relative;">
              ${avatar ? `<img class="avatar" src="${avatar}" alt="${escapeHtml(s.full_name || "profil")}" referrerpolicy="no-referrer" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'avatar-fallback',textContent:'${initials}'}));" />` : `<div class="avatar-fallback">${initials}</div>`}
            </div>
            <div>
              <h3>${escapeHtml(s.full_name || "Nume necunoscut")}</h3>
              <p class="headline">${escapeHtml(s.headline || "")}</p>
            </div>
          </div>
          <div class="tags">
            ${s.job_title ? `<span class="tag">${escapeHtml(s.job_title)}</span>` : ""}
            ${s.job_title_2 ? `<span class="tag" style="opacity:0.8;">${escapeHtml(s.job_title_2)}</span>` : ""}
          </div>
          <div class="meta-row">
            ${s.location ? `<span>üìç ${escapeHtml(s.location)}</span>` : ""}
            ${s.school ? `<span>üéì ${escapeHtml([s.school, s.school_degree].filter(Boolean).join(" ‚Ä¢ "))}</span>` : ""}
          </div>
          <div class="card-actions">
            ${profileUrl ? `<a class="mini-btn primary" href="${escapeHtml(profileUrl)}" target="_blank" rel="noopener noreferrer">LinkedIn ‚Üó</a>` : '<span class="mini-btn" style="opacity:0.6; cursor:default;">No LinkedIn</span>'}
            <button class="mini-btn" data-copy="${escapeHtml(profileUrl)}">Copy URL</button>
            <button class="mini-btn" data-copy="${escapeHtml(vmid)}">Copy VMID</button>
          </div>
        `;

        card.querySelectorAll("button[data-copy]").forEach((b) => {
          b.addEventListener("click", async () => {
            const val = b.getAttribute("data-copy") || "";
            if (!val) return;
            await copyToClipboard(val);
            const old = b.textContent;
            b.textContent = "Copied ‚úÖ";
            setTimeout(() => (b.textContent = old), 1000);
          });
        });

        return card;
      }

      function setLoading(isLoading) {
        askBtn.disabled = isLoading;
        btnText.textContent = isLoading ? "Se genereazƒÉ" : "GenereazƒÉ";
        statusEl.textContent = isLoading ? "Se proceseazƒÉ" : "PregƒÉtit";
        answerEl.style.opacity = isLoading ? 0.6 : 1;
        profilesEl.style.opacity = isLoading ? 0.6 : 1;
      }

      async function ask() {
        const query = (qEl.value || "").trim();
        if (!query) return;

        if (abortController) abortController.abort();
        abortController = new AbortController();

        setLoading(true);
        answerHint.textContent = "Se genereazƒÉ rƒÉspunsul...";
        profilesEl.innerHTML = "";
        cardCountEl.textContent = "0 carduri";
        answerEl.classList.remove("placeholder");
        answerEl.innerHTML = `<span style="color: var(--muted);">Se genereazƒÉ rƒÉspunsul...</span>`;

        const started = performance.now();

        try {
          const res = await fetch("/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
            signal: abortController.signal,
          });

          if (!res.ok) throw new Error(await res.text());

          const data = await res.json();
          const elapsed = ((performance.now() - started) / 1000).toFixed(2);

          lastAnswerRaw = data.answer || "";
          answerEl.innerHTML = formatAnswer(lastAnswerRaw || "Nu am putut genera un rƒÉspuns.");

          const sources = dedupeSources(data.sources || []);
          if (sources.length === 0) {
            profilesEl.innerHTML = `<div class="empty">Nu au fost gƒÉsite profile relevante.</div>`;
          } else {
            profilesEl.innerHTML = "";
            sources.forEach((s, i) => profilesEl.appendChild(buildCard(s, i)));
          }

          metaModel.textContent = `Model: ${data.llm_used || "‚Äî"}`;
          metaDocs.textContent = `Docs: ${data.retrieved_docs ?? "‚Äî"}`;
          metaTime.textContent = `Latency: ${data.latency_sec ?? elapsed}s`;
          metaUniq.textContent = `Cards: ${sources.length}`;

          cardCountEl.textContent = `${sources.length} card${sources.length === 1 ? "" : "uri"}`;
          answerHint.textContent = `Latency: ${data.latency_sec ?? elapsed}s ‚Ä¢ ${sources.length} card${sources.length === 1 ? "" : "uri"}`;
          statusEl.textContent = "Complet";
        } catch (err) {
          if (String(err).includes("AbortError")) {
            answerEl.innerHTML = `<span style="color: var(--muted);">Cererea a fost anulatƒÉ.</span>`;
            statusEl.textContent = "Anulat";
          } else {
            answerEl.innerHTML = `<span style="color: var(--muted);">Eroare: ${escapeHtml(err.message || String(err))}</span>`;
            statusEl.textContent = "Eroare";
          }
        } finally {
          setLoading(false);
        }
      }

      askBtn.addEventListener("click", ask);
      qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          ask();
        }
      });

      document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          qEl.value = chip.dataset.q || "";
          ask();
        });
      });

      copyAnswerBtn.addEventListener("click", async () => {
        if (!lastAnswerRaw) return;
        await copyToClipboard(lastAnswerRaw);
        const old = copyAnswerBtn.textContent;
        copyAnswerBtn.textContent = "Copied ‚úÖ";
        setTimeout(() => (copyAnswerBtn.textContent = old), 900);
      });
    </script>
  </body>
</html>

<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMWTechWorks ‚Äì Talent Intelligence</title>

  <style>
    :root{
      --bg0:#050816;
      --bg1:#08102a;
      --card:#0b1736;
      --card2:#0a1430;
      --stroke:rgba(148,163,184,0.25);
      --text:#e2e8f0;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --accent2:#0ea5e9;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 70% 30%, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(900px 500px at 20% 60%, rgba(14,165,233,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid rgba(148,163,184,0.12);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(5,8,22,0.55);
      z-index:10;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:700;
    }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border:1px solid rgba(56,189,248,0.35);
      border-radius:999px;
      color:var(--accent);
      background: rgba(56,189,248,0.08);
      font-weight:600;
      letter-spacing:0.2px;
    }

    .container{
      max-width:1120px;
      margin:0 auto;
      padding:18px;
    }

    .queryRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-top:18px;
    }
    .queryBox{
      flex:1;
      background: rgba(11,23,54,0.65);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:16px;
      padding:14px;
    }
    textarea{
      width:100%;
      min-height:64px;
      resize:vertical;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
      line-height:1.4;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(56,189,248,0.35);
      background: linear-gradient(180deg, rgba(56,189,248,0.18), rgba(14,165,233,0.10));
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btnSecondary{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(11,23,54,0.45);
      font-weight:600;
    }

    .small{
      font-size:12px; color:var(--muted)
    }

    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0 0 0;
    }
    .chip{
      padding:6px 10px;
      border:1px solid rgba(148,163,184,0.20);
      border-radius:999px;
      font-size:12px;
      color:rgba(226,232,240,0.9);
      background: rgba(11,23,54,0.45);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:14px;
      margin-top:16px;
      align-items:start;
    }

    .panel{
      background: rgba(11,23,54,0.55);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:16px;
      padding:14px;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .panelTitle{
      font-size:12px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(226,232,240,0.75);
      font-weight:800;
    }

    .analysisText{
      white-space:pre-wrap;
      line-height:1.45;
      font-size:14px;
      color:rgba(226,232,240,0.92);
      min-height:120px;
    }

    .cardsHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .card{
      background: rgba(10,20,48,0.65);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height:130px;
    }
    .avatar{
      width:42px; height:42px; border-radius:999px;
      background: rgba(148,163,184,0.15);
      border:1px solid rgba(148,163,184,0.18);
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}

    .cardName{
      font-weight:800;
      margin:0;
      font-size:14px;
    }
    .cardMeta{
      margin-top:6px;
      font-size:12px;
      color:rgba(226,232,240,0.70);
      line-height:1.35;
    }
    .tagRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.22);
      background: rgba(56,189,248,0.08);
      color:rgba(226,232,240,0.85);
      font-size:11px;
      font-weight:700;
    }
    .cardBtns{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .miniBtn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(11,23,54,0.45);
      color:rgba(226,232,240,0.88);
      font-size:12px;
      cursor:pointer;
      font-weight:700;
    }
    .miniBtn:hover{border-color: rgba(56,189,248,0.35)}
    .right{
      display:flex; gap:10px; align-items:center;
    }
    select{
      background: rgba(11,23,54,0.55);
      border:1px solid rgba(148,163,184,0.22);
      color:rgba(226,232,240,0.9);
      border-radius:12px;
      padding:8px 10px;
      outline:0;
      font-weight:700;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:rgba(226,232,240,0.80);
      user-select:none;
    }
    .toggle input{transform: translateY(1px)}

    .statusRow{
      margin-top:8px;
      font-size:12px;
      color:rgba(226,232,240,0.65);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      align-items:center;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(148,163,184,0.45);
      display:inline-block;
    }
    .dot.ok{background:rgba(16,185,129,0.85)}
    .dot.busy{background:rgba(245,158,11,0.9)}

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:18px;
    }
    .modal{
      width:min(980px, 96vw);
      background: rgba(10,20,48,0.92);
      border:1px solid rgba(148,163,184,0.22);
      border-radius:16px;
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(148,163,184,0.16);
    }
    .modalTitle{
      font-weight:900;
      font-size:12px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(226,232,240,0.82);
    }
    .modalBody{
      padding:14px;
    }
    .tabs{
      display:flex; gap:8px; align-items:center;
      margin-bottom:10px;
    }
    .tab{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(11,23,54,0.45);
      color:rgba(226,232,240,0.8);
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(56,189,248,0.35);
      color: rgba(226,232,240,0.95);
      background: rgba(56,189,248,0.10);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:rgba(226,232,240,0.8);
      background: rgba(5,8,22,0.55);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:12px;
      padding:10px;
      white-space:pre-wrap;
      line-height:1.35;
    }
    #archDiagram{
      background: rgba(5,8,22,0.45);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:12px;
      padding:10px;
      overflow:auto;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .cards{grid-template-columns:1fr}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div style="font-size:14px;">BMWTechWorks</div>
      <span class="pill">TALENT INTELLIGENCE</span>
    </div>

    <div class="right">
      <span id="metaModel" class="small">Model: ‚Äî</span>
      <span id="metaDocs" class="small">Docs: ‚Äî</span>
      <span id="metaLatency" class="small">Latency: ‚Äî</span>
      <span id="metaTokens" class="small">Tokens: ‚Äî</span>

      <select id="cardsK">
        <option value="8">Cards: 8</option>
        <option value="16" selected>Cards: 16</option>
        <option value="24">Cards: 24</option>
        <option value="48">Cards: 48</option>
      </select>

      <button class="btn btnSecondary" id="viewArchBtn">View Architecture</button>
    </div>
  </div>

  <div class="container">
    <div class="queryRow">
      <div class="queryBox">
        <textarea id="queryInput" placeholder="ex: cine sunt generative ai engineers?"></textarea>

        <div class="chips">
          <div class="chip">Infrastructure Engineers</div>
          <div class="chip">Masteranzi UBB</div>
          <div class="chip">Skill: Java/Python</div>
          <div class="chip">Statistici Software</div>
        </div>
      </div>

      <div style="width:260px">
        <div class="controls">
          <button class="btn" id="generateBtn">GenereazƒÉ ‚ö°</button>
        </div>

        <div style="margin-top:10px;">
          <label class="toggle">
            <input type="checkbox" id="analysisToggle" checked />
            AI analysis
          </label>
        </div>

        <div class="statusRow">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">PregƒÉtit</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">AI Analysis</div>
          <button class="miniBtn" id="copyAnswerBtn">Copy answer</button>
        </div>
        <div id="analysisText" class="analysisText">‚Äî</div>
      </div>

      <div class="panel">
        <div class="cardsHeader">
          <div class="panelTitle">Identified Profiles</div>
          <div class="small"><span id="cardsCount">0</span> carduri</div>
        </div>
        <div id="cards" class="cards"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal">
      <div class="modalTop">
        <div>
          <div class="modalTitle">Live Application Architecture</div>
          <div class="small">Vizualizare live a fluxului de la interfa»õƒÉ la rƒÉspunsul AI</div>
        </div>
        <div class="right">
          <button class="tab active" data-tab="live">Live</button>
          <button class="tab" data-tab="latency">Latency</button>
          <button class="tab" data-tab="cache">Cache/Store</button>
          <button class="btn btnSecondary" id="closeModalBtn">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div id="tab_live">
          <div id="archDiagram"></div>
        </div>
        <div id="tab_latency" style="display:none">
          <div class="mono" id="latencyBox">‚Äî</div>
        </div>
        <div id="tab_cache" style="display:none">
          <div class="mono" id="cacheBox">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    mermaid.initialize({ startOnLoad: false });

    const queryInput = document.getElementById("queryInput");
    const generateBtn = document.getElementById("generateBtn");
    const analysisToggle = document.getElementById("analysisToggle");
    const cardsEl = document.getElementById("cards");
    const cardsCountEl = document.getElementById("cardsCount");
    const analysisTextEl = document.getElementById("analysisText");
    const copyAnswerBtn = document.getElementById("copyAnswerBtn");
    const cardsKEl = document.getElementById("cardsK");

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");

    const metaModel = document.getElementById("metaModel");
    const metaDocs = document.getElementById("metaDocs");
    const metaLatency = document.getElementById("metaLatency");
    const metaTokens = document.getElementById("metaTokens");

    const viewArchBtn = document.getElementById("viewArchBtn");
    const modalWrap = document.getElementById("modalWrap");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const archDiagramEl = document.getElementById("archDiagram");
    const latencyBox = document.getElementById("latencyBox");
    const cacheBox = document.getElementById("cacheBox");

    let lastAnswer = "";
    let lastArch = null;
    let lastRagMeta = null;

    function setBusy(isBusy){
      statusDot.classList.remove("ok","busy");
      statusDot.classList.add(isBusy ? "busy" : "ok");
      statusText.textContent = isBusy ? "RuleazƒÉ..." : "PregƒÉtit";
      generateBtn.disabled = isBusy;
    }

    function esc(s){
      return (s || "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderCards(sources){
      cardsEl.innerHTML = "";
      cardsCountEl.textContent = sources.length;

      for(const s of sources){
        const name = s.full_name || "‚Äî";
        const role = s.job_title || "";
        const headline = s.headline || "";
        const loc = s.location || "";
        const date = s.job_date_range || "";
        const school = s.school || "";
        const degree = s.school_degree || "";

        const tags = [];
        if (role) tags.push(role);
        if ((s.job_title_2||"").trim()) tags.push(s.job_title_2);
        if ((s.school_degree||"").trim()) tags.push(s.school_degree);

        const avatarHtml = s.profile_image_url
          ? `<div class="avatar"><img src="${esc(s.profile_image_url)}" alt=""></div>`
          : `<div class="avatar"></div>`;

        const tagHtml = tags.slice(0,3).map(t => `<span class="tag">${esc(t)}</span>`).join("");

        const profileUrl = s.profile_url || "";
        const vmid = s.vmid || s.source_id || "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          ${avatarHtml}
          <div style="flex:1">
            <p class="cardName">${esc(name)}</p>

            <div class="tagRow">${tagHtml}</div>

            <div class="cardMeta">
              ${role ? `üìå ${esc(role)}<br/>` : ""}
              ${headline && headline !== role ? `üß† ${esc(headline)}<br/>` : ""}
              ${loc ? `üìç ${esc(loc)}<br/>` : ""}
              ${date ? `üóìÔ∏è ${esc(date)}<br/>` : ""}
              ${(school || degree) ? `üéì ${esc(school)} ${degree ? "‚Ä¢ " + esc(degree) : ""}` : ""}
            </div>

            <div class="cardBtns">
              ${profileUrl ? `<button class="miniBtn" data-action="open" data-url="${esc(profileUrl)}">LinkedIn ‚Üó</button>` : ""}
              ${profileUrl ? `<button class="miniBtn" data-action="copy" data-text="${esc(profileUrl)}">Copy URL</button>` : ""}
              ${vmid ? `<button class="miniBtn" data-action="copy" data-text="${esc(vmid)}">Copy VMID</button>` : ""}
            </div>
          </div>
        `;

        card.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if(!btn) return;
          const action = btn.dataset.action;
          if(action === "open"){
            window.open(btn.dataset.url, "_blank");
          } else if(action === "copy"){
            navigator.clipboard.writeText(btn.dataset.text || "");
          }
          e.stopPropagation();
        });

        cardsEl.appendChild(card);
      }
    }

    function updateTopMeta(meta){
      // keep last
      lastRagMeta = meta;

      metaModel.textContent = `Model: ${meta.llm_provider || "‚Äî"}`;
      metaDocs.textContent = `Docs: ${meta.retrieved_docs ?? "‚Äî"} (rag)`;
      metaLatency.textContent = `Latency: ${meta.latency_sec ?? "‚Äî"}s (R:${meta.retrieval_sec ?? "‚Äî"} L:${meta.llm_sec ?? "‚Äî"})`;

      const tu = meta.token_usage || {};
      metaTokens.textContent = `Tokens P:${tu.prompt_tokens ?? "‚Äî"} C:${tu.completion_tokens ?? "‚Äî"} T:${tu.total_tokens ?? "‚Äî"}`;
    }

    async function doSearch(query){
      const k = parseInt(cardsKEl.value, 10) || 16;
      const res = await fetch("/search",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ query, k })
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error("Search failed: " + t);
      }
      return await res.json();
    }

    async function doAnalysis(query){
      // IMPORTANT FIX:
      // Send same k to /query as we used for cards,
      // so RAG sees the same neighborhood (instead of default k=8).
      const k = parseInt(cardsKEl.value, 10) || 16;

      const res = await fetch("/query",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ query, with_llm: true, k })
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error("Query failed: " + t);
      }
      return await res.json();
    }

    function buildMermaid(arch){
      // No "shadow:drop-shadow(...)" inside classDef (mermaid parse error).
      const llm = arch?.llm_provider || "OPENAI";
      const vdb = arch?.vectordb || "Chroma";
      const emb = arch?.embedding_model || "text-embedding-3-large";

      return `
flowchart TD
  subgraph Q[1. Query & API]
    U([User Query]) --> API[FastAPI Backend]
  end

  subgraph R[2. Retrieval]
    API --> E[Embedding Model\\n${emb}]
    E --> VDB[(Vector DB\\n${vdb})]
    VDB --> RC[Retrieved Chunks]
  end

  subgraph L[3. Reasoning]
    RC --> LLM[LLM Provider\\n${llm}]
  end

  subgraph O[4. Response]
    LLM --> A([Final Answer])
  end

  classDef node fill:#0b1736,stroke:#94a3b8,color:#e2e8f0,stroke-width:1px;
  classDef accent fill:#0a2a52,stroke:#38bdf8,color:#e2e8f0,stroke-width:2px;
  class U,API,RC,LLM,A node;
  class E,VDB accent;
      `.trim();
    }

    async function renderArchitecture(){
      if(!lastArch){
        archDiagramEl.innerHTML = `<div class="mono">Nu am arhitecturƒÉ √ÆncƒÉ. RuleazƒÉ o √Æntrebare cu AI analysis activ.</div>`;
        return;
      }

      // live diagram
      const code = buildMermaid(lastArch);
      archDiagramEl.innerHTML = `<div class="mermaid">${esc(code)}</div>`;
      try{
        await mermaid.run({ querySelector: ".mermaid" });
      }catch(err){
        archDiagramEl.innerHTML = `<div class="mono">Nu am putut desena arhitectura (eroare mermaid). Detalii: ${esc(err?.message || err)}</div>`;
      }

      // latency tab
      if(lastRagMeta){
        latencyBox.textContent =
          `Latency R: ${lastRagMeta.retrieval_sec}s\n` +
          `Latency L: ${lastRagMeta.llm_sec}s\n` +
          `LLM: ${lastArch.llm_provider || "‚Äî"}\n` +
          `Vector DB: ${lastArch.vectordb || "‚Äî"}\n` +
          `Tokens P:${(lastRagMeta.token_usage||{}).prompt_tokens} C:${(lastRagMeta.token_usage||{}).completion_tokens} T:${(lastRagMeta.token_usage||{}).total_tokens}`;
      } else {
        latencyBox.textContent = "‚Äî";
      }

      // cache tab
      cacheBox.textContent = JSON.stringify({ architecture: lastArch, meta: lastRagMeta }, null, 2);
    }

    function openModal(){
      modalWrap.style.display = "flex";
      renderArchitecture();
    }
    function closeModal(){
      modalWrap.style.display = "none";
    }

    function switchTab(tabName){
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add("active");

      document.getElementById("tab_live").style.display = (tabName==="live") ? "" : "none";
      document.getElementById("tab_latency").style.display = (tabName==="latency") ? "" : "none";
      document.getElementById("tab_cache").style.display = (tabName==="cache") ? "" : "none";
    }

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> switchTab(t.dataset.tab));
    });

    viewArchBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);
    modalWrap.addEventListener("click", (e)=> { if(e.target === modalWrap) closeModal(); });

    copyAnswerBtn.addEventListener("click", ()=>{
      navigator.clipboard.writeText(lastAnswer || "");
    });

    async function run(){
      const query = (queryInput.value || "").trim();
      if(!query) return;

      setBusy(true);
      analysisTextEl.textContent = "‚Äî";

      try{
        // 1) Search (cards)
        const searchRes = await doSearch(query);
        renderCards(searchRes.sources || []);

        // 2) Analysis (LLM)
        if(analysisToggle.checked){
          const ragRes = await doAnalysis(query);

          lastAnswer = (ragRes.answer || "").trim();
          analysisTextEl.textContent = lastAnswer || "Modelul nu a returnat con»õinut text pentru aceastƒÉ cerere (posibil refuz sau rƒÉspuns gol).";

          // architecture/meta
          lastArch = ragRes.architecture || null;
          updateTopMeta({
            llm_provider: (ragRes.architecture||{}).llm_provider || "OPENAI",
            retrieved_docs: ragRes.retrieved_docs,
            latency_sec: ragRes.latency_sec,
            retrieval_sec: ragRes.retrieval_sec,
            llm_sec: ragRes.llm_sec,
            token_usage: ragRes.token_usage || {},
          });
        } else {
          analysisTextEl.textContent = "AI analysis este dezactivat.";
          lastAnswer = "";
        }

      }catch(err){
        analysisTextEl.textContent = "Eroare: " + (err?.message || err);
      }finally{
        setBusy(false);
      }
    }

    generateBtn.addEventListener("click", run);
    queryInput.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        run();
      }
    });

    // initial
    setBusy(false);
  </script>
</body>
</html>

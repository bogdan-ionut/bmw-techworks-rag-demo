<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMW TechWorks ‚Ä¢ RAG Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #030712;
        --panel: rgba(255, 255, 255, 0.04);
        --panel2: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.94);
        --muted: rgba(255, 255, 255, 0.68);
        --muted2: rgba(255, 255, 255, 0.48);
        --accent: #4ade80;
        --accent2: #38bdf8;
        --good: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --shadow: 0 28px 60px rgba(0, 0, 0, 0.55);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, sans-serif;
        color: var(--text);
        background:
          radial-gradient(1200px 700px at 12% 10%, rgba(74,222,128,0.20), transparent 55%),
          radial-gradient(1000px 680px at 82% 0%, rgba(56,189,248,0.18), transparent 55%),
          radial-gradient(1400px 780px at 40% 100%, rgba(99,102,241,0.14), transparent 60%),
          var(--bg);
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 28px 18px 70px;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 14px;
        margin-bottom: 8px;
      }

      .title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .title h1 {
        margin: 0;
        font-size: 26px;
        letter-spacing: -0.5px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .badge {
        font-size: 12px;
        font-weight: 800;
        padding: 4px 12px;
        border-radius: 999px;
        color: #04121a;
        background: linear-gradient(135deg, #4ade80, #38bdf8);
        box-shadow: 0 16px 36px rgba(56,189,248,0.18);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
      }

      .tagline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.04);
        color: var(--muted);
        font-size: 12px;
        margin-top: 10px;
      }

      .pipeline {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 12px 0 6px;
      }

      .step {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.05);
        font-size: 12px;
        color: var(--muted);
      }

      .step strong {
        color: var(--text);
        letter-spacing: -0.1px;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 8px;
      }

      .stat {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
        display: grid;
        gap: 4px;
      }

      .stat .label { font-size: 11px; color: var(--muted2); letter-spacing: 0.08em; text-transform: uppercase; }
      .stat .value { font-size: 16px; font-weight: 800; letter-spacing: -0.2px; }

      .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 4px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }

      .pill strong { color: var(--text); font-weight: 700; }

      .panel {
        border: 1px solid var(--border);
        background: linear-gradient(160deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      .ask {
        padding: 16px;
      }

      .ask-grid {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 14px;
        align-items: start;
      }

      textarea {
        width: 100%;
        min-height: 86px;
        resize: vertical;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.26);
        color: var(--text);
        padding: 12px 12px;
        font-size: 14px;
        line-height: 1.4;
        outline: none;
      }

      textarea:focus {
        border-color: rgba(56,189,248,0.6);
        box-shadow: 0 0 0 3px rgba(56,189,248,0.12);
      }

      .btn {
        border: 0;
        cursor: pointer;
        border-radius: 14px;
        padding: 14px 16px;
        font-weight: 800;
        color: #04121a;
        background: linear-gradient(135deg, #4ade80, #22c55e);
        box-shadow: 0 16px 32px rgba(34,197,94,0.24);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        min-width: 160px;
        justify-content: center;
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .chip {
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        color: var(--muted);
        padding: 7px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
        transition: all 0.15s ease;
      }

      .chip:hover {
        border-color: rgba(74,222,128,0.55);
        color: var(--text);
        box-shadow: 0 6px 18px rgba(74,222,128,0.25);
      }

      .content {
        display: grid;
        grid-template-columns: 1.35fr 1fr;
        gap: 14px;
        margin-top: 14px;
      }

      .box {
        padding: 14px;
      }

      .box h2 {
        margin: 0 0 10px;
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--muted2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .hint {
        font-size: 11px;
        color: var(--muted2);
        letter-spacing: normal;
        text-transform: none;
      }

      .answer {
        border-top: 1px solid var(--border);
        padding-top: 12px;
        color: var(--text);
        font-size: 14px;
        line-height: 1.55;
        white-space: normal;
      }

      .answer a { color: var(--accent); text-decoration: none; font-weight: 700; }
      .answer a:hover { text-decoration: underline; }
      .answer .muted { color: var(--muted); }

      .sources-wrap {
        border-top: 1px solid var(--border);
        padding-top: 12px;
      }

      .carousel {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(260px, 1fr);
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
      }

      .carousel::-webkit-scrollbar { height: 10px; }
      .carousel::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.10);
        border-radius: 999px;
      }

      .card {
        scroll-snap-align: start;
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        background: linear-gradient(175deg, rgba(255,255,255,0.05), rgba(0,0,0,0.22));
        box-shadow: 0 18px 42px rgba(0,0,0,0.42);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 340px;
      }

      .card-top {
        display: grid;
        grid-template-columns: 62px 1fr;
        gap: 10px;
        align-items: center;
      }

      .avatar {
        width: 62px;
        height: 62px;
        border-radius: 16px;
        object-fit: cover;
        border: 1px solid rgba(74,222,128,0.28);
        background: rgba(255,255,255,0.08);
      }

      .name {
        font-weight: 800;
        font-size: 15px;
        margin: 0;
        line-height: 1.2;
      }

      .headline {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.25;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tag {
        font-size: 12px;
        color: var(--text);
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .mini {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--text);
        font-weight: 800;
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
      }

      .mini.primary {
        background: linear-gradient(135deg, rgba(74,222,128,0.18), rgba(56,189,248,0.18));
        border-color: rgba(74,222,128,0.45);
      }

      .mini:hover { border-color: rgba(255,255,255,0.18); }

      .section {
        border-top: 1px solid var(--border);
        padding-top: 10px;
        display: grid;
        gap: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      .kv b { color: var(--text); }

      details {
        border-top: 1px solid var(--border);
        padding-top: 10px;
      }

      details summary {
        cursor: pointer;
        color: var(--muted);
        font-weight: 700;
      }

      pre {
        margin: 10px 0 0;
        padding: 10px;
        background: rgba(0,0,0,0.35);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: auto;
        color: rgba(255,255,255,0.85);
        font-size: 11px;
      }

      .statusline {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .left-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .dot {
        width: 10px; height: 10px; border-radius: 999px;
        background: rgba(255,255,255,0.25);
      }
      .dot.loading { background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,0.12); }
      .dot.ok { background: var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,0.12); }
      .dot.err { background: var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,0.12); }

      @media (max-width: 980px) {
        .content { grid-template-columns: 1fr; }
        .ask-grid { grid-template-columns: 1fr; }
        .btn { width: 100%; min-width: unset; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="title">
          <h1>BMW TechWorks <span class="badge">RAG Demo</span></h1>
          <p class="subtitle">
            √éntreabƒÉ √Æn limbaj natural. Backend-ul face retrieval din Chroma + LLM »ôi returneazƒÉ rƒÉspuns + surse (profiluri).
            <span class="subtitle" style="display:block; margin-top:4px; color: rgba(255,255,255,0.45);">
              Tip: folose»ôte √ÆntrebƒÉri ‚Äúinterview style‚Äù (roluri, tech stack, loca»õii, senioritate, studen»õi, etc).
            </span>
          </p>
        </div>

        <div class="stat-grid" style="max-width: 520px;">
          <div class="stat"><div class="label">Model</div><div class="value" id="meta-model">‚Äî</div></div>
          <div class="stat"><div class="label">k (retrieval)</div><div class="value" id="meta-k">‚Äî</div></div>
          <div class="stat"><div class="label">Latency</div><div class="value" id="meta-latency">‚Äî</div></div>
          <div class="stat"><div class="label">Docs</div><div class="value" id="meta-docs">‚Äî</div></div>
          <div class="stat"><div class="label">Employees</div><div class="value" id="meta-uniq">‚Äî</div></div>
        </div>
      </div>

      <div class="tagline">‚ö° Demo ready pentru interviu: smart, explicabil »ôi vizual ‚Äî vezi imediat fluxul RAG »ôi sursele reale.</div>

      <div class="pipeline">
        <div class="step">üîé <strong>Retrieve</strong> ‚Üí Chroma DB (vectori OpenAI)</div>
        <div class="step">üìö <strong>Ground</strong> ‚Üí chunk-uri √ÆmbogƒÉ»õite cu metadate</div>
        <div class="step">üß† <strong>Answer</strong> ‚Üí LLM + citate din surse unice</div>
        <div class="step">üß≠ <strong>Audit</strong> ‚Üí vezi cardurile deduplicate & raw</div>
      </div>

      <div class="panel ask">
        <div class="ask-grid">
          <div>
            <textarea id="q" placeholder="Ex: Avem oameni pe Talent Acquisition / HR? ListeazƒÉ cu rol + loca»õie + LinkedIn."></textarea>
            <div class="chips">
              <div class="chip" data-q="Avem oameni √Æn zona HR / Talent Acquisition? ListeazƒÉ nume, rol, loca»õie »ôi LinkedIn.">HR / Talent</div>
              <div class="chip" data-q="GƒÉse»ôte Infrastructure Engineers (sau DevOps/SRE) »ôi spune unde sunt localiza»õi.">Infrastructure</div>
              <div class="chip" data-q="Cine sunt studen»õi (√Æn headline) »ôi pe ce tehnologii par sƒÉ fie?">Students</div>
              <div class="chip" data-q="C√¢»õi angaja»õi au √Æn headline 'AI' sau 'Machine Learning'? DƒÉ-mi lista.">AI / ML</div>
              <div class="chip" data-q="CautƒÉ oameni care au UBB / UTCN la educa»õie. ListeazƒÉ.">UBB / UTCN</div>
            </div>

            <div class="statusline">
              <div class="left-status">
                <span class="dot" id="dot"></span>
                <span id="status">idle</span>
                <span class="pill" style="padding:6px 10px;">Ctrl+Enter pentru submit</span>
              </div>
              <div class="left-status">
                <button class="mini" id="btn-cancel" style="display:none;">Cancel</button>
                <button class="mini" id="btn-copy-answer" title="CopiazƒÉ rƒÉspunsul">Copy Answer</button>
              </div>
            </div>
          </div>

          <button id="btn" class="btn">üí¨ √éntreabƒÉ RAG</button>
        </div>
      </div>

      <div class="content">
        <div class="panel box">
          <h2>RƒÉspuns <span class="hint" id="answer-hint"></span></h2>
          <div class="answer" id="answer">
            <span class="muted">Scrie o √Æntrebare »ôi apasƒÉ ‚Äú√éntreabƒÉ RAG‚Äù.</span>
          </div>
        </div>

        <div class="panel box">
          <h2>Surse (Employee Cards) <span class="hint" id="src-hint"></span></h2>
          <div class="sources-wrap">
            <div class="carousel" id="carousel"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const q = $("q");
      const btn = $("btn");
      const cancelBtn = $("btn-cancel");
      const copyAnswerBtn = $("btn-copy-answer");
      const dot = $("dot");
      const statusEl = $("status");

      const answerEl = $("answer");
      const carousel = $("carousel");

      const metaModel = $("meta-model");
      const metaK = $("meta-k");
      const metaLatency = $("meta-latency");
      const metaDocs = $("meta-docs");
      const metaUniq = $("meta-uniq");

      const answerHint = $("answer-hint");
      const srcHint = $("src-hint");

      let abortController = null;
      let lastAnswerRaw = "";

      function setStatus(state, text) {
        statusEl.textContent = text;
        dot.className = "dot";
        if (state === "loading") dot.classList.add("loading");
        if (state === "ok") dot.classList.add("ok");
        if (state === "err") dot.classList.add("err");
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // super lightweight markdown-ish renderer: **bold**, links [t](url), line breaks
      function renderAnswer(md) {
        let s = escapeHtml(md || "");
        s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        s = s.replace(/\[(.+?)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        s = s.replace(/\n/g, "<br/>");
        return s;
      }

      const fallbackAvatar = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop stop-color="#4ade80" offset="0"/>
              <stop stop-color="#38bdf8" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="160" height="160" rx="30" fill="url(#g)"/>
          <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="Inter,Arial" font-size="32" fill="#04121a" font-weight="800">BMW</text>
        </svg>
      `)}`;

      function normalizeLinkedIn(url) {
        if (!url) return "";
        let clean = String(url).trim();
        clean = clean.replace("www.linkedin.com", "linkedin.com").replace("http://", "https://");
        clean = clean.split("?")[0];
        return clean.replace(/\/$/, "").toLowerCase();
      }

      function sourceKey(s) {
        const vmid = (s.vmid || "").trim().toLowerCase();
        const profile = normalizeLinkedIn(s.profile_url);
        const name = (s.full_name || "").trim().toLowerCase();
        const sourceId = (s.source_id || "").trim().toLowerCase();
        return vmid || profile || name || sourceId || JSON.stringify(s);
      }

      function completenessScore(s) {
        let score = 0;
        const weighted = {
          profile_image_url: 3,
          profile_url: 2,
          headline: 2,
          job_title: 2,
          location: 2,
          job_title_2: 1,
          school: 1,
          school_2: 1,
        };
        for (const [k, weight] of Object.entries(weighted)) {
          if (s[k]) score += weight;
        }
        score += Object.values(s).filter((v) => v !== null && v !== "" && v !== undefined).length;
        return score;
      }

      function mergeSources(a, b) {
        const pickBase = completenessScore(b) > completenessScore(a) ? [b, a] : [a, b];
        const [base, secondary] = pickBase.map((x) => ({ ...x }));
        for (const [k, v] of Object.entries(secondary)) {
          if (base[k] === undefined || base[k] === null || base[k] === "") base[k] = v;
        }
        return base;
      }

      function dedupeSources(sources) {
        const map = new Map();
        for (const s of sources || []) {
          const key = sourceKey(s);
          if (!key) continue;
          if (!map.has(key)) map.set(key, s);
          else map.set(key, mergeSources(map.get(key), s));
        }
        return Array.from(map.values());
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function cardTag(icon, text) {
        if (!text) return "";
        return `<span class="tag">${icon ? icon + " " : ""}${escapeHtml(text)}</span>`;
      }

      function resolveAvatarSrc(s) {
        const img = (s.profile_image_url || "").trim();
        if (!img) return fallbackAvatar;

        const linkedinImg = normalizeLinkedIn(img).includes("media.licdn.com");
        if (linkedinImg) {
          const proxied = `https://images.weserv.nl/?url=${encodeURIComponent(img.replace(/^https?:\/\//, ""))}&w=320&h=320&fit=cover`;
          return proxied;
        }
        return escapeHtml(img);
      }

      function buildCard(s, idx) {
        const name = s.full_name || "Nume necunoscut";
        const headline = s.headline || "";
        const location = s.location || "";
        const job1 = [s.job_title, s.job_date_range].filter(Boolean).join(" ‚Ä¢ ");
        const job2 = [s.job_title_2, s.job_date_range_2].filter(Boolean).join(" ‚Ä¢ ");

        const edu1 = [s.school, s.school_degree, s.school_date_range].filter(Boolean).join(" ‚Ä¢ ");
        const edu2 = [s.school_2, s.school_degree_2, s.school_date_range_2].filter(Boolean).join(" ‚Ä¢ ");

        const profileUrl = s.profile_url || "";
        const vmid = s.vmid || "";

        const avatarSrc = resolveAvatarSrc(s);

        const raw = escapeHtml(JSON.stringify(s, null, 2));

        return `
          <div class="card">
            <div class="card-top">
              <img class="avatar" src="${avatarSrc}" alt="photo" referrerpolicy="no-referrer" loading="lazy" onerror="this.src='${fallbackAvatar}';this.onerror=null;" />
              <div>
                <p class="name">#${idx + 1} ‚Ä¢ ${escapeHtml(name)}</p>
                ${headline ? `<p class="headline">${escapeHtml(headline)}</p>` : `<p class="headline" style="opacity:.7">‚Äî</p>`}
              </div>
            </div>

            <div class="tags">
              ${location ? cardTag("üìç", location) : ""}
              ${s.job_title ? cardTag("üíº", s.job_title) : ""}
              ${s.job_title_2 ? cardTag("üß©", s.job_title_2) : ""}
            </div>

            <div class="btn-row">
              ${
                profileUrl
                  ? `<a class="mini primary" href="${escapeHtml(profileUrl)}" target="_blank" rel="noopener noreferrer">LinkedIn ‚Üó</a>`
                  : `<span class="mini" style="opacity:.6; cursor:default;">No LinkedIn</span>`
              }
              <button class="mini" data-copy="${escapeHtml(profileUrl)}">Copy URL</button>
              <button class="mini" data-copy="${escapeHtml(vmid)}">Copy VMID</button>
            </div>

            <div class="section">
              ${job1 ? `<div class="kv"><b>Current:</b> ${escapeHtml(job1)}</div>` : ""}
              ${job2 ? `<div class="kv"><b>Previous:</b> ${escapeHtml(job2)}</div>` : ""}
              ${edu1 ? `<div class="kv"><b>Edu 1:</b> ${escapeHtml(edu1)}</div>` : ""}
              ${edu2 ? `<div class="kv"><b>Edu 2:</b> ${escapeHtml(edu2)}</div>` : ""}
            </div>

            <details>
              <summary>More details (raw)</summary>
              <pre>${raw}</pre>
            </details>
          </div>
        `;
      }

      function wireCardButtons() {
        carousel.querySelectorAll("button[data-copy]").forEach((b) => {
          b.addEventListener("click", async () => {
            const val = b.getAttribute("data-copy") || "";
            if (!val) return;
            await copyToClipboard(val);
            const old = b.textContent;
            b.textContent = "Copied ‚úÖ";
            setTimeout(() => (b.textContent = old), 900);
          });
        });
      }

      function resetMeta() {
        metaModel.textContent = "‚Äî";
        metaK.textContent = "‚Äî";
        metaLatency.textContent = "‚Äî";
        metaDocs.textContent = "‚Äî";
        metaUniq.textContent = "‚Äî";
      }

      async function askRag() {
        const query = (q.value || "").trim();
        if (!query) return;

        // cancel previous
        if (abortController) abortController.abort();
        abortController = new AbortController();

        btn.disabled = true;
        cancelBtn.style.display = "inline-flex";
        setStatus("loading", "loading‚Ä¶");
        answerHint.textContent = "";
        srcHint.textContent = "";
        answerEl.innerHTML = `<span class="muted">Se genereazƒÉ rƒÉspunsul‚Ä¶</span>`;
        carousel.innerHTML = "";
        resetMeta();

        const started = performance.now();

        try {
          const res = await fetch("/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
            signal: abortController.signal,
          });

          if (!res.ok) {
            const t = await res.text();
            throw new Error(`HTTP ${res.status}: ${t}`);
          }

          const data = await res.json();
          const elapsed = ((performance.now() - started) / 1000).toFixed(2);

          lastAnswerRaw = data.answer || "";
          answerEl.innerHTML = renderAnswer(lastAnswerRaw);

          const sources = dedupeSources(data.sources || []);
          carousel.innerHTML = sources.map((s, i) => buildCard(s, i)).join("");
          wireCardButtons();

          metaModel.textContent = data.llm_used || "‚Äî";
          metaK.textContent = "8"; // dacƒÉ vrei exact, returneazƒÉ-l din backend
          metaLatency.textContent = `${data.latency_sec ?? elapsed}s`;
          metaDocs.textContent = String(data.retrieved_docs ?? "‚Äî");
          metaUniq.textContent = String(sources.length);

          answerHint.textContent = `latency ~${data.latency_sec ?? elapsed}s`;
          srcHint.textContent = `${sources.length} cards`;

          setStatus("ok", "done");
        } catch (err) {
          if (String(err).includes("AbortError")) {
            setStatus("err", "cancelled");
            answerEl.innerHTML = `<span class="muted">Cererea a fost anulatƒÉ.</span>`;
          } else {
            setStatus("err", "error");
            answerEl.innerHTML = `<span class="muted">Eroare: ${escapeHtml(err.message || String(err))}</span>`;
          }
        } finally {
          btn.disabled = false;
          cancelBtn.style.display = "none";
        }
      }

      btn.addEventListener("click", askRag);

      cancelBtn.addEventListener("click", () => {
        if (abortController) abortController.abort();
      });

      copyAnswerBtn.addEventListener("click", async () => {
        if (!lastAnswerRaw) return;
        await copyToClipboard(lastAnswerRaw);
        const old = copyAnswerBtn.textContent;
        copyAnswerBtn.textContent = "Copied ‚úÖ";
        setTimeout(() => (copyAnswerBtn.textContent = old), 900);
      });

      q.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          askRag();
        }
      });

      document.querySelectorAll(".chip").forEach((c) => {
        c.addEventListener("click", () => {
          q.value = c.getAttribute("data-q") || "";
          askRag();
        });
      });

      setStatus("ok", "idle");
    </script>
  </body>
</html>
